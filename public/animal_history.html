<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Expires" content="0">
    <title data-lang-key="title">قائمة الحيوانات</title>
    <style>
        :root {
            --primary-green: #28a745;
            --background-white: #ffffff;
            --text-dark: #343a40;
            --border-color: #ced4da;
            --light-gray: #f8f9fa;
        }
        body {
            font-family: 'Tahoma', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-dark);
            margin: 0;
            min-height: 100vh;
            text-align: right;
        }
        body[dir="ltr"] {
            font-family: 'Arial', sans-serif;
            text-align: left;
        }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
            background: var(--background-white);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: var(--primary-green);
            text-align: center;
            margin-bottom: 20px;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .select-all-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: right;
        }
        th {
            background: #f8f9fa;
            position: relative;
        }
        .filter-container {
            position: relative;
        }
        .filter-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--primary-green);
        }
        .filter-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            min-width: 150px;
            display: none;
        }
        .filter-checkbox {
            display: block;
            margin-bottom: 5px;
        }
        .filter-select-all {
            margin-bottom: 10px;
            font-weight: bold;
            cursor: pointer;
            color: var(--primary-green);
        }
        .date-filter {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .date-input {
            width: 100%;
            padding: 3px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .checkbox-col {
            width: 50px;
            text-align: center;
        }
        .edit-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .edit-btn:hover {
            background: #1e7e34;
        }
        .language-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
        }
        body[dir="ltr"] .language-toggle {
            left: auto;
            right: 10px;
        }
        .language-toggle button {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
        }
        .error {
            text-align: center;
            color: #dc3545;
            padding: 20px;
        }
        @media (max-width: 768px) {
            table {
                font-size: 0.8em;
            }
            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-dropdown {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="language-toggle">
        <button id="lang-toggle" data-lang-key="lang_toggle">EN</button>
    </div>
    <div class="container">
        <h2 data-lang-key="animals_list_title">قائمة الحيوانات المسجلة</h2>
        <div class="table-controls">
            <button id="select-all-btn" class="select-all-btn" data-lang-key="select_all">تحديد الكل</button>
            <button id="deselect-all-btn" class="select-all-btn" data-lang-key="deselect_all" style="display: none;">إلغاء تحديد الكل</button>
        </div>
        <table id="animals-table">
            <thead>
                <tr>
                    <th class="checkbox-col"><input type="checkbox" id="master-checkbox"></th>
                    <th data-column="id" class="filter-container">
                        <span data-lang-key="id">ID</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('id')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="animal_name" class="filter-container">
                        <span data-lang-key="animal_name">اسم الحيوان</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('animal_name')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="animal_code" class="filter-container">
                        <span data-lang-key="code">الرمز</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('animal_code')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="animal_type" class="filter-container">
                        <span data-lang-key="type">النوع</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('animal_type')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="animal_source" class="filter-container">
                        <span data-lang-key="source">المصدر</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('animal_source')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="gender" class="filter-container">
                        <span data-lang-key="gender">الجنس</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('gender')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="breed" class="filter-container">
                        <span data-lang-key="breed">السلالة</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('breed')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="color" class="filter-container">
                        <span data-lang-key="color">اللون</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('color')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="estimated_age" class="filter-container">
                        <span data-lang-key="age">العمر</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('estimated_age')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="delivered_by_empid" class="filter-container">
                        <span data-lang-key="delivered_empid">رقم المُسلّم</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('delivered_by_empid')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="owner_name" class="filter-container">
                        <span data-lang-key="owner_name">اسم المالك</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('owner_name')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="created_by" class="filter-container">
                        <span data-lang-key="created_by">مُنشئ</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('created_by')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="is_active" class="filter-container">
                        <span data-lang-key="status">الحالة</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown">
                            <div class="filter-select-all" onclick="toggleAllFilters('is_active')">تحديد الكل</div>
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </th>
                    <th data-column="registration_date" class="filter-container">
                        <span data-lang-key="reg_date">تاريخ التسجيل</span>
                        <button class="filter-btn">▼</button>
                        <div class="filter-dropdown date-filter">
                            <label data-lang-key="from_date">من تاريخ:</label>
                            <input type="date" class="date-input" id="date-from">
                            <label data-lang-key="to_date">إلى تاريخ:</label>
                            <input type="date" class="date-input" id="date-to">
                            <button onclick="applyDateFilter()" data-lang-key="apply_filter" style="margin-top: 5px;">تطبيق</button>
                        </div>
                    </th>
                    <th data-lang-key="actions">إجراءات</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Rows will be populated here -->
            </tbody>
        </table>
        <div id="loading" class="loading" style="display: none;" data-lang-key="loading">جاري تحميل البيانات...</div>
        <div id="error-message" class="error" style="display: none;"></div>
    </div>
    <script src="session_check.js"></script>
    <script>
        let currentLang = localStorage.getItem('lang') || 'ar';
        let translations = {};
        let allAnimals = [];
        let filteredAnimals = [];

        // دالة تحميل الترجمة
        async function loadTranslations(lang) {
            try {
                const res = await fetch(`../languages/${lang}.json?t=${Date.now()}`);
                translations = await res.json();
                applyTranslations();
            } catch (e) {
                console.error('Error loading translations:', e);
            }
        }

        // دالة تطبيق الترجمات
        function applyTranslations() {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[key]) {
                    el.textContent = translations[key];
                }
            });
        }

        // جلب الحيوانات
        async function fetchAnimals() {
            document.getElementById('loading').style.display = 'block';
            try {
                console.log('Fetching animals...');
                const res = await fetch('../api/get_animals.php?action=get_all&t=' + Date.now());
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('API Response:', data);
                if (data.success) {
                    allAnimals = data.animals;
                    filteredAnimals = [...allAnimals];
                    populateFilters();
                    renderTable(filteredAnimals);
                } else {
                    showError(data.message || 'خطأ في جلب البيانات.');
                }
            } catch (e) {
                console.error('Fetch error:', e);
                showError('خطأ في الاتصال بالسيرفر: ' + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ملء الفلاتر بالقيم الفريدة
        function populateFilters() {
            const columns = ['animal_type', 'animal_source', 'gender', 'breed', 'color', 'estimated_age', 'delivered_by_empid', 'owner_name', 'created_by', 'is_active'];
            columns.forEach(col => {
                const uniqueValues = [...new Set(allAnimals.map(a => a[col] || '').filter(v => v))].sort();
                const dropdown = document.querySelector(`th[data-column="${col}"] .filter-dropdown`);
                let checkboxesHtml = '';
                uniqueValues.forEach(value => {
                    checkboxesHtml += `<label class="filter-checkbox"><input type="checkbox" value="${value}" data-column="${col}">${value}</label>`;
                });
                dropdown.innerHTML = `<div class="filter-select-all" onclick="toggleAllFilters('${col}')">تحديد الكل</div>` + checkboxesHtml;
            });
        }

        // تبديل الفلاتر
        function toggleFilter(column, value, checked) {
            const dropdown = document.querySelector(`th[data-column="${column}"] .filter-dropdown`);
            dropdown.style.display = 'none';
            filterTable();
        }

        // تبديل الكل في فلتر
        function toggleAllFilters(column) {
            const checkboxes = document.querySelectorAll(`input[data-column="${column}"]`);
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            filterTable();
        }

        // تطبيق فلتر التاريخ
        function applyDateFilter() {
            const fromDate = document.getElementById('date-from').value;
            const toDate = document.getElementById('date-to').value;
            const dropdown = document.querySelector('th[data-column="registration_date"] .filter-dropdown');
            dropdown.style.display = 'none';
            filterTable();
        }

        // فلترة الجدول
        function filterTable() {
            filteredAnimals = allAnimals.filter(animal => {
                // فلترة الحقول النصية
                return Object.keys(animal).every(key => {
                    if (key === 'id' || key === 'photos' || key === 'notes' || key === 'registration_date') return true;
                    const checkboxes = document.querySelectorAll(`input[data-column="${key}"]:checked`);
                    if (checkboxes.length === 0) return true;
                    const animalValue = animal[key] || '';
                    return Array.from(checkboxes).some(cb => cb.value === animalValue);
                }) && filterDateRange(animal.registration_date);
            });
            renderTable(filteredAnimals);
        }

        // فلترة التاريخ
        function filterDateRange(dateStr) {
            const fromDate = document.getElementById('date-from').value;
            const toDate = document.getElementById('date-to').value;
            if (!fromDate && !toDate) return true;
            const animalDate = new Date(dateStr);
            if (fromDate && !toDate) {
                return animalDate >= new Date(fromDate);
            }
            if (!fromDate && toDate) {
                return animalDate <= new Date(toDate);
            }
            if (fromDate && toDate) {
                return animalDate >= new Date(fromDate) && animalDate <= new Date(toDate);
            }
            return true;
        }

        // إظهار/إخفاء الفلتر
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = btn.nextElementSibling;
                const isVisible = dropdown.style.display === 'block';
                document.querySelectorAll('.filter-dropdown').forEach(d => d.style.display = 'none');
                dropdown.style.display = isVisible ? 'none' : 'block';
            });
        });

        // إغلاق الفلاتر عند النقر خارجها
        document.addEventListener('click', () => {
            document.querySelectorAll('.filter-dropdown').forEach(d => d.style.display = 'none');
        });

        // عرض الجدول
        function renderTable(animals) {
            const tbody = document.getElementById('table-body');
            if (animals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align: center;" data-lang-key="no_results">لا توجد نتائج.</td></tr>';
                return;
            }
            let html = '';
            animals.forEach(animal => {
                html += `
                    <tr>
                        <td class="checkbox-col"><input type="checkbox" class="row-checkbox"></td>
                        <td>${animal.id}</td>
                        <td>${animal.animal_name || ''}</td>
                        <td>${animal.animal_code}</td>
                        <td>${animal.animal_type}</td>
                        <td>${animal.animal_source}</td>
                        <td>${animal.gender}</td>
                        <td>${animal.breed || ''}</td>
                        <td>${animal.color || ''}</td>
                        <td>${animal.estimated_age || ''}</td>
                        <td>${animal.delivered_by_empid || ''}</td>
                        <td>${animal.owner_name || ''}</td>
                        <td>${animal.created_by || ''}</td>
                        <td>${animal.is_active}</td>
                        <td>${animal.registration_date}</td>
                        <td><a href="add_animals.html?ID=${animal.id}" class="edit-btn" data-lang-key="edit">تعديل</a></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
            applyTranslations();
        }

        // تحديد/إلغاء الكل
        document.getElementById('master-checkbox').addEventListener('change', function() {
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = this.checked);
        });

        document.getElementById('select-all-btn').addEventListener('click', () => {
            document.getElementById('master-checkbox').checked = true;
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('deselect-all-btn').style.display = 'inline-block';
            document.getElementById('select-all-btn').style.display = 'none';
        });

        document.getElementById('deselect-all-btn').addEventListener('click', () => {
            document.getElementById('master-checkbox').checked = false;
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('deselect-all-btn').style.display = 'none';
            document.getElementById('select-all-btn').style.display = 'inline-block';
        });

        // إضافة event listeners للفلاتر
        document.addEventListener('change', (e) => {
            if (e.target.matches('input[data-column]')) {
                toggleFilter(e.target.dataset.column, e.target.value, e.target.checked);
            }
        });

        document.addEventListener('change', (e) => {
            if (e.target.id === 'date-from' || e.target.id === 'date-to') {
                applyDateFilter();
            }
        });

        function showError(msg) {
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('animals-table').style.display = 'none';
        }

        // تحميل الموارد
        async function loadResources() {
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.body.lang = currentLang;
            document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            await loadTranslations(currentLang);
            fetchAnimals();
        }

        // زر تبديل اللغة
        document.getElementById('lang-toggle').addEventListener('click', function() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('lang', currentLang);
            document.getElementById('lang-toggle').textContent = currentLang === 'ar' ? 'EN' : 'عربي';
            loadResources();
        });

        window.onload = loadResources;
    </script>
</body>
</html>