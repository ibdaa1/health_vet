<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</title>
<style>
body { font-family: 'Cairo', sans-serif; background: #f5f7fa; margin: 0; padding: 20px; color: #333; }
.container { max-width: 1000px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.1);}
h2 { text-align: center; color: #006e3a; }
input, select, textarea { padding: 5px; margin: 2px 0; border-radius: 6px; border: 1px solid #ccc; }
.results-table { width:100%; border-collapse:collapse; margin-top:12px; }
.results-table th, .results-table td { border:1px solid #ccc; padding:7px 4px; text-align:center;}
.results-table th { background:#e9ecef; }
.page-btns {margin:10px 0; text-align:center;}
.page-btns button {padding:5px 10px; margin:0 2px;}
#editModal {display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.12); z-index:10;}
#editModal .modal-content {background:#fff; max-width:600px; margin:48px auto; border-radius:10px; padding:20px; position:relative;}
#editModal .close {position:absolute; left:14px; top:14px; cursor:pointer; font-size:20px;}
img.preview {width:60px; height:60px; object-fit:cover; border-radius:4px; border:1px solid #ccc;}
</style>
</head>
<body>
<div class="container">
    <h2>Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h2>
    <form id="searchForm">
        <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰ØŒ Ø§Ø³Ù…ØŒ Ù…Ù†Ø·Ù‚Ø©ØŒ Ù†ÙˆØ¹..." style="width:220px;">
        <button type="submit">Ø¨Ø­Ø«</button>
    </form>
    <div id="results"></div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ / Ø§Ø¹ØªÙ…Ø§Ø¯ -->
<div id="editModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <form id="editForm">
        <input type="hidden" name="ComplaintID" id="editComplaintID">
        <label>Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
        <input type="text" id="editComplaintNo" disabled style="background:#f5f5f5;">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªÙƒÙŠ:</label>
        <input type="text" name="ComplainantName" id="editComplainantName">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
        <input type="text" name="ComplainantPhone" id="editComplainantPhone">
        <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
        <input type="text" name="Area" id="editArea">
        <label>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</label>
        <input type="text" name="Coordinates" id="editCoordinates">
        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
        <input type="text" name="City" id="editCity">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
        <select name="ComplaintType" id="editComplaintType">
            <option value="Cats">Ù‚Ø·Ø·</option>
            <option value="Dogs">ÙƒÙ„Ø§Ø¨</option>
        </select>
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª:</label>
        <input type="number" name="AnimalCount" id="editAnimalCount">
        <label>Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:</label>
        <select name="ResponsePriority" id="editResponsePriority">
            <option value="Emergency">Ø·Ø§Ø±Ø¦Ø©</option>
            <option value="Scheduled">Ù…Ø¬Ø¯ÙˆÙ„Ø©</option>
        </select>
        <label>ÙˆØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
        <textarea name="ComplainantStatement" id="editComplainantStatement"></textarea>
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„:</label>
        <select name="KPI_Method" id="editKPI_Method">
            <option value="Cage">Ù‚ÙØµ</option>
            <option value="Net">Ø´Ø¨ÙƒØ©</option>
            <option value="Manual">ÙŠØ¯ÙˆÙŠ</option>
            <option value="Other">Ø£Ø®Ø±Ù‰</option>
        </select>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</label>
        <input type="datetime-local" name="FollowUpDate" id="editFollowUpDate">
        <label>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</label>
        <textarea name="FollowUpAction" id="editFollowUpAction"></textarea>
        <label>ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ÙØ±ÙŠÙ‚:</label>
        <textarea name="TeamFollowUp" id="editTeamFollowUp"></textarea>
        
        <!-- Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±/Ø§Ø¯Ù…Ù† -->
        <div id="managerFields" style="background:#fcfcf1; border-radius:7px; padding:10px; margin:10px 0;">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±:</label>
            <textarea name="ManagerComment" id="editManagerComment"></textarea>
            <label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</label>
            <select name="FinalStatus" id="editFinalStatus">
                <option value="Pending Close">Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</option>
                <option value="Closed">Ù…ØºÙ„Ù‚Ø©</option>
                <option value="Rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
            </select>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:</label>
            <input type="datetime-local" name="CloseDate" id="editCloseDate">
        </div>
        <div id="photoContainer"></div>
        <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button type="button" id="btnDelete" style="background:#b70e2b;">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙˆÙ‰</button>
    </form>
    <div id="modalMsg" style="text-align:center;margin-top:8px;color:#006e3a;"></div>
  </div>
</div>

<script>
let userIsManager = false, userIsAdmin = false;

// Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
async function getUserRights() {
    const r = await fetch('/health_vet/api/user_data.php?action=get_user_data');
    const d = await r.json();
    userIsManager = d.user_data?.IsLicenseManager==1;
    userIsAdmin = d.user_data?.IsAdmin==1;
    if(!userIsManager && !userIsAdmin) document.getElementById('managerFields').style.display='none';
}

// Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
let lastQ = ''; let lastPage = 1;
async function searchComplaints(page=1){
    const q = document.getElementById('searchInput').value.trim();
    lastQ = q; lastPage = page;
    const form = new FormData();
    form.append('action','search');
    form.append('q',q);
    form.append('page',page);
    const res = await fetch('/health_vet/api/complaints_crud.php',{method:'POST',body:form});
    const data = await res.json();
    let html = '';
    if(data.success && data.data.length){
        html += `<table class="results-table"><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªÙƒÙŠ</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ù†ÙˆØ¹</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr>`;
        data.data.forEach(c=>{
            html += `<tr>
                <td>${c.ComplaintNo}</td>
                <td>${c.ComplainantName}</td>
                <td>${c.Area}</td>
                <td>${c.ComplaintType}</td>
                <td>${c.ComplaintDate?.replace('T',' ').slice(0,16)||''}</td>
                <td>${c.FinalStatus||''}</td>
                <td><button onclick="editComplaint(${c.ComplaintID})">ØªØ¹Ø¯ÙŠÙ„</button></td>
            </tr>`;
        }); html += '</table>';
        html += `<div class="page-btns">`;
        html += `<button ${data.page==1?"disabled":""} onclick="searchComplaints(${data.page-1})">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>`;
        html += `<span>ØµÙØ­Ø© ${data.page}/${data.pages}</span>`;
        html += `<button ${data.page==data.pages?"disabled":""} onclick="searchComplaints(${data.page+1})">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
        html += `</div>`;
    }else{
        html = `<div class="error">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
    }
    document.getElementById('results').innerHTML = html;
}
document.getElementById('searchForm').onsubmit = e=>{ e.preventDefault(); searchComplaints(1); };

// Ø¬Ù„Ø¨ Ø´ÙƒÙˆÙ‰ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
window.editComplaint = async function(id){
    document.getElementById('editModal').style.display='block';
    document.getElementById('modalMsg').textContent='';
    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    document.getElementById('managerFields').style.display = (userIsAdmin||userIsManager)?'block':'none';
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const form = new FormData();
    form.append('action','get');
    form.append('ComplaintID',id);
    const res = await fetch('/health_vet/api/complaints_crud.php',{method:'POST',body:form});
    const d = await res.json();
    if(d.success){
        const c = d.data;
        document.getElementById('editComplaintID').value = c.ComplaintID;
        document.getElementById('editComplaintNo').value = c.ComplaintNo;
        document.getElementById('editComplainantName').value = c.ComplainantName||'';
        document.getElementById('editComplainantPhone').value = c.ComplainantPhone||'';
        document.getElementById('editArea').value = c.Area||'';
        document.getElementById('editCoordinates').value = c.Coordinates||'';
        document.getElementById('editCity').value = c.City||'';
        document.getElementById('editComplaintType').value = c.ComplaintType||'Cats';
        document.getElementById('editAnimalCount').value = c.AnimalCount||1;
        document.getElementById('editResponsePriority').value = c.ResponsePriority||'Scheduled';
        document.getElementById('editComplainantStatement').value = c.ComplainantStatement||'';
        document.getElementById('editKPI_Method').value = c.KPI_Method||'Cage';
        document.getElementById('editFollowUpDate').value = c.FollowUpDate?.slice(0,16)||'';
        document.getElementById('editFollowUpAction').value = c.FollowUpAction||'';
        document.getElementById('editTeamFollowUp').value = c.TeamFollowUp||'';
        document.getElementById('editManagerComment').value = c.ManagerComment||'';
        document.getElementById('editFinalStatus').value = c.FinalStatus||'Pending Close';
        document.getElementById('editCloseDate').value = c.CloseDate?.slice(0,16)||'';
        // Ø§Ù„ØµÙˆØ±
        let photoHtml = '';
        if(c.PhotoURLs){
            c.PhotoURLs.split('|').forEach(url=>{
                photoHtml += `<img class="preview" src="/health_vet/${url}?t=${Date.now()}">`;
            });
        }
        document.getElementById('photoContainer').innerHTML = photoHtml;
    }
};
// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
document.getElementById('editForm').onsubmit = async function(e){
    e.preventDefault();
    const form = new FormData(this);
    form.append('action','update');
    const res = await fetch('/health_vet/api/complaints_crud.php',{method:'POST',body:form});
    const d = await res.json();
    document.getElementById('modalMsg').textContent = d.success?'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'âŒ '+d.message;
    if(d.success) setTimeout(()=>{closeModal();searchComplaints(lastPage);},1200);
};
// Ø­Ø°Ù Ø´ÙƒÙˆÙ‰
document.getElementById('btnDelete').onclick = async function(){
    if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')){
        const id = document.getElementById('editComplaintID').value;
        const form = new FormData();
        form.append('action','delete');
        form.append('ComplaintID',id);
        const res = await fetch('/health_vet/api/complaints_crud.php',{method:'POST',body:form});
        const d = await res.json();
        document.getElementById('modalMsg').textContent = d.success?'âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù':'âŒ '+d.message;
        if(d.success) setTimeout(()=>{closeModal();searchComplaints(lastPage);},1200);
    }
};
function closeModal(){document.getElementById('editModal').style.display='none';}

getUserRights();
searchComplaints(1);
</script>
</body>
</html>