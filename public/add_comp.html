<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªØ³Ø¬ÙŠÙ„/ØªØ¹Ø¯ÙŠÙ„ Ø´ÙƒÙˆÙ‰</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
/* -------------------- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙØ­Ø³Ù† ÙˆØ§Ù„ØªØ¬Ø§ÙˆØ¨ÙŠ -------------------- */
:root {
    --primary-green: #028a48; /* Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    --secondary-beige: #f4f7f4; /* Ø®Ù„ÙÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© */
    --background-white: #ffffff;
    --text-dark: #34495e;
    --border-color: #dcdcdc;
}
body {
    font-family: 'Cairo', sans-serif;
    padding: 20px 10px;
    background-color: var(--secondary-beige);
    color: var(--text-dark);
    margin: 0;
}
.container {
    width: 100%;
    max-width: 800px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    margin: auto;
    background-color: var(--background-white);
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
h2 { color: var(--primary-green); text-align: center; margin-bottom: 20px; }
label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.95em; }
input:not([type="checkbox"]):not([type="radio"]), select, textarea {
    width: 100%;
    padding: 9px;
    margin-top: 5px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 0.9em;
    transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus { border-color: var(--primary-green); outline: none; }
textarea { resize: vertical; min-height: 80px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.full-width { grid-column: 1 / -1; }

/* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
#managerFields {
    background: #fdfde9;
    border: 1px dashed #e6e6b4;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
}

/* Ø²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ */
#coordinates-container {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}
#map-pin-btn {
    background-color: #3498db;
    color: white;
    padding: 9px 12px;
    font-size: 0.9em;
    width: auto;
    flex-shrink: 0;
}
#map-pin-btn:hover { background-color: #2980b9; }
#map { height: 250px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
button.action-btn { 
    background-color: var(--primary-green); 
    color: white; 
    padding: 12px 25px; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer; 
    margin-top: 20px; 
    font-size: 1em; 
    width: auto;
}
#searchForm button { margin: 0; padding: 10px 15px; }
#delete_button { background-color: #e74c3c; margin-right: 10px; }
#delete_button:hover { background-color: #c0392b; }

/* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… */
#message, #auth_status { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; }
.success { background-color: #e8f5e9; color: #1e7e34; }
.error { background-color: #fbecec; color: #c0392b; }
.info { background-color: #eaf4fb; color: #2980b9; }

/* Ù„Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
    .container { padding: 20px; }
    button.action-btn { width: 100%; margin-top: 15px; }
}
</style>
</head>
<body>
<div class="container">
    <h2>ØªØ³Ø¬ÙŠÙ„/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h2>

    <form id="searchForm" class="full-width" style="margin-bottom: 20px; display: flex; gap: 10px;">
        <input type="text" id="complaintSearchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§..." style="flex-grow: 1;">
        <button type="submit">Ø¨Ø­Ø«</button>
        <button type="button" onclick="resetForm()">+ Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©</button>
    </form>
    
    <div id="auth_status" class="info">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</div>

    <form id="complaintForm" style="display:none;" autocomplete="off">
        <input type="hidden" name="ComplaintID" id="ComplaintID">

        <div class="form-grid">
            <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
                <input type="text" id="ComplaintNo" readonly>
            
                <label for="ComplainantName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªÙƒÙŠ:</label>
                <input type="text" name="ComplainantName" id="ComplainantName">

                <label for="ComplainantPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                <input type="text" name="ComplainantPhone" id="ComplainantPhone">

                <label for="Source">Ù…ØµØ¯Ø± Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
                <select name="Source" id="Source">
                    <option value="Hotline">Ù‡Ø§ØªÙ Ø³Ø§Ø®Ù†</option>
                    <option value="In-person">Ø´Ø®ØµÙŠØ§Ù‹</option>
                    <option value="Department">Ù‚Ø³Ù…</option>
                    <option value="Email">Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                    <option value="SocialMedia">Ø´Ø¨ÙƒØ§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</option>
                </select>
                
                <label for="ComplaintType">Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
                <select name="ComplaintType" id="ComplaintType">
                    <option value="Cats">Ù‚Ø·Ø·</option>
                    <option value="Dogs">ÙƒÙ„Ø§Ø¨</option>
                </select>

                <label for="AnimalCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª:</label>
                <input type="number" name="AnimalCount" id="AnimalCount" min="1" value="1">
            </div>

            <div>
                <label for="ComplaintDate">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø´ÙƒÙˆÙ‰:</label>
                <input type="datetime-local" name="ComplaintDate" id="ComplaintDate" required>
                
                <label for="ReceivedDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                <input type="datetime-local" name="ReceivedDate" id="ReceivedDate">

                <label for="ReceivedByEmpID">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙØ³ØªÙ„ÙÙ…:</label>
                <select name="ReceivedByEmpID" id="ReceivedByEmpID">
                    <option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù...</option>
                </select>
                <label for="ResponsePriority">Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:</label>
                <select name="ResponsePriority" id="ResponsePriority">
                    <option value="Scheduled">Ù…Ø¬Ø¯ÙˆÙ„Ø©</option>
                    <option value="Emergency">Ø·Ø§Ø±Ø¦Ø©</option>
                </select>

                <label for="City">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                <input type="text" name="City" id="City" value="Sharjah">
                
                <label for="Area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
                <input type="text" name="Area" id="Area">
            </div>

            <div class="full-width">
                <label for="Coordinates">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø®Ø· Ø§Ù„Ø·ÙˆÙ„):</label>
                <div id="coordinates-container">
                    <input type="text" name="Coordinates" id="Coordinates" readonly placeholder="Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                    <button type="button" id="map-pin-btn">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                </div>
                <div id="map"></div>
            </div>

            <div class="full-width">
                <label for="ComplainantStatement">ÙˆØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰ (Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø´ØªÙƒÙŠ):</label>
                <textarea name="ComplainantStatement" id="ComplainantStatement"></textarea>
            </div>

            <div class="form-grid">
                <div>
                    <label for="KPI_Method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„:</label>
                    <select name="KPI_Method" id="KPI_Method">
                        <option value="Cage">Ù‚ÙØµ</option>
                        <option value="Net">Ø´Ø¨ÙƒØ©</option>
                        <option value="Manual">ÙŠØ¯ÙˆÙŠ</option>
                        <option value="Other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                    
                    <label for="FollowUpDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</label>
                    <input type="datetime-local" name="FollowUpDate" id="FollowUpDate">
                </div>
                <div>
                    <label for="FollowUpAction">Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</label>
                    <textarea name="FollowUpAction" id="FollowUpAction"></textarea>
                </div>
            </div>

            <div class="full-width">
                <label for="TeamFollowUp">ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ÙØ±ÙŠÙ‚:</label>
                <textarea name="TeamFollowUp" id="TeamFollowUp"></textarea>
            </div>

            <div id="managerFields" class="full-width" style="display: none;">
                <label for="ManagerComment">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¥Ø¯Ø§Ø±ÙŠ ÙÙ‚Ø·):</label>
                <textarea name="ManagerComment" id="ManagerComment"></textarea>
                
                <div class="form-grid">
                    <div>
                        <label for="FinalStatus">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</label>
                        <select name="FinalStatus" id="FinalStatus">
                            <option value="Pending Close">Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</option>
                            <option value="Closed">Ù…ØºÙ„Ù‚Ø©</option>
                            <option value="Rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
                        </select>
                    </div>
                    <div>
                        <label for="CloseDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:</label>
                        <input type="datetime-local" name="CloseDate" id="CloseDate">
                    </div>
                </div>
            </div>

            <div id="photoContainer" class="full-width" style="margin:10px 0;"></div>

            <div class="full-width" style="text-align: right;">
                <button type="submit" class="action-btn" id="submit_button">ğŸ’¾ Ø­ÙØ¸/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</button>
                <button type="button" class="action-btn" id="delete_button" style="display:none;">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙˆÙ‰</button>
            </div>
        </div>
    </form>
    <div id="message"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let currentUser = null;
let map, marker;
const API_URL = '../api/complaints_crud.php';

// ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§)
function setDefaultDateTime(id) {
    const input = document.getElementById(id);
    if (!input.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        input.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
}

// Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© ReceivedByEmpID
async function loadEmployees() {
    try {
        // ØªÙØªØ±Ø¶ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© EmpID Ùˆ EmpName
        const res = await fetch('../api/get_employees.php'); 
        const data = await res.json();
        const select = document.getElementById('ReceivedByEmpID');
        if (data.success && Array.isArray(data.data)) {
            data.data.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp.EmpID;
                opt.textContent = emp.EmpName;
                select.appendChild(opt);
            });
        }
    } catch(e) {
        console.error("Error loading employees:", e);
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function initMap(lat=25.357, lng=55.395) { // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø§Ù„Ø´Ø§Ø±Ù‚Ø©)
    if (map) map.remove();

    map = L.map('map').setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    marker = L.marker([lat, lng], { draggable: true }).addTo(map);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø³Ø­Ø¨ Ø§Ù„Ø¯Ø¨ÙˆØ³
    marker.on('dragend', function(e) {
        const coords = e.target.getLatLng();
        document.getElementById('Coordinates').value = `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        document.getElementById('Coordinates').value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø´ÙƒÙˆÙ‰ Ù…Ø¹ÙŠÙ†Ø© (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
async function loadComplaint(id) {
    resetForm(false);
    document.getElementById('ComplaintID').value = id;
    document.getElementById('submit_button').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
    document.getElementById('delete_button').style.display = (currentUser?.permissions?.canDelete || currentUser?.permissions?.isAdmin) ? 'inline-block' : 'none';

    try {
        const form = new FormData();
        form.append('action', 'get');
        form.append('ComplaintID', id);
        const res = await fetch(API_URL, { method: 'POST', body: form });
        const d = await res.json();

        if (d.success) {
            const c = d.data;
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            document.getElementById('ComplaintNo').value = c.ComplaintNo;
            document.getElementById('ComplainantName').value = c.ComplainantName || '';
            document.getElementById('ComplainantPhone').value = c.ComplainantPhone || '';
            document.getElementById('Source').value = c.Source || 'Hotline';
            document.getElementById('ComplaintType').value = c.ComplaintType || 'Cats';
            document.getElementById('AnimalCount').value = c.AnimalCount || 1;
            document.getElementById('ResponsePriority').value = c.ResponsePriority || 'Scheduled';
            document.getElementById('City').value = c.City || 'Sharjah';
            document.getElementById('Area').value = c.Area || '';
            document.getElementById('ComplainantStatement').value = c.ComplainantStatement || '';
            document.getElementById('KPI_Method').value = c.KPI_Method || 'Cage';
            document.getElementById('FollowUpAction').value = c.FollowUpAction || '';
            document.getElementById('TeamFollowUp').value = c.TeamFollowUp || '';

            // Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
            document.getElementById('ComplaintDate').value = c.ComplaintDate?.slice(0, 16) || '';
            document.getElementById('ReceivedDate').value = c.ReceivedDate?.slice(0, 16) || ''; // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            document.getElementById('FollowUpDate').value = c.FollowUpDate?.slice(0, 16) || '';
            document.getElementById('CloseDate').value = c.CloseDate?.slice(0, 16) || '';

            // Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³ØªÙ„Ù…
            document.getElementById('ReceivedByEmpID').value = c.ReceivedByEmpID || '';
            
            // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
            if (currentUser?.permissions?.isAdmin) { // ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ø¯Ø§Ø±ÙŠØ§Ù‹
                document.getElementById('ManagerComment').value = c.ManagerComment || '';
                document.getElementById('FinalStatus').value = c.FinalStatus || 'Pending Close';
            }

            // Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø©
            document.getElementById('Coordinates').value = c.Coordinates || '';
            if (c.Coordinates) {
                const [lat, lng] = c.Coordinates.split(',').map(s => parseFloat(s.trim()));
                if (!isNaN(lat) && !isNaN(lng)) {
                    initMap(lat, lng);
                    marker.setLatLng([lat, lng]);
                }
            } else {
                initMap(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªØªÙˆÙØ±
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
            let photoHtml = '';
            if(c.PhotoURLs){
                c.PhotoURLs.split('|').forEach(url=>{
                    photoHtml += `<img class="preview" src="/health_vet/${url}?t=${Date.now()}" style="width:60px; height:60px; object-fit:cover; border-radius:5px; border:1px solid #ccc; margin-left:3px;">`;
                });
            }
            document.getElementById('photoContainer').innerHTML = photoHtml;
            
            document.getElementById('message').innerHTML = `<div class="success">âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ #${c.ComplaintNo} Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.</div>`;

        } else {
            document.getElementById('message').innerHTML = `<div class="error">âŒ ${d.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙƒÙˆÙ‰'}</div>`;
            resetForm();
        }
    } catch (e) {
        document.getElementById('message').innerHTML = `<div class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${e.message}</div>`;
    }
}

// ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©
function resetForm(clearInput=true) {
    document.getElementById('complaintForm').reset();
    document.getElementById('ComplaintID').value = '';
    document.getElementById('ComplaintNo').value = 'ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
    document.getElementById('submit_button').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
    document.getElementById('delete_button').style.display = 'none';
    document.getElementById('photoContainer').innerHTML = '';
    document.getElementById('Coordinates').value = '';
    
    if(clearInput) document.getElementById('complaintSearchInput').value = '';

    setDefaultDateTime('ComplaintDate');
    setDefaultDateTime('ReceivedDate');
    initMap(); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
}

// Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
async function getUserRights() {
    const authDiv = document.getElementById('auth_status');
    try {
        const res = await fetch('../api/user_data.php?action=get_user_data');
        currentUser = await res.json();
        
        if (currentUser.success && currentUser.user_data?.EmpID) {
            authDiv.style.display = 'none';
            document.getElementById('complaintForm').style.display = 'block';
            
            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
            const isAdmin = currentUser.permissions.isAdmin;
            document.getElementById('managerFields').style.display = isAdmin ? 'block' : 'none';
            
            resetForm(); // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… Ø´ÙƒÙˆÙ‰ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
            const urlParams = new URLSearchParams(window.location.search);
            const complaintId = urlParams.get('id');
            if (complaintId) {
                loadComplaint(complaintId);
            }

        } else {
            authDiv.textContent = 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„.';
            authDiv.className = 'error';
        }
    } catch(e) {
        authDiv.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + e.message;
        authDiv.className = 'error';
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø¨Ø­Ø«
document.getElementById('searchForm').onsubmit = async function(e) {
    e.preventDefault();
    const complaintNo = document.getElementById('complaintSearchInput').value.trim();
    if (complaintNo) {
        // ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø³ØªØ®Ø¯Ù… API Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ID
        try {
            const form = new FormData();
            form.append('action', 'search_by_no'); // Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
            form.append('ComplaintNo', complaintNo);
            const res = await fetch(API_URL, { method: 'POST', body: form });
            const d = await res.json();
            
            if (d.success && d.data) {
                loadComplaint(d.data.ComplaintID);
                document.getElementById('message').innerHTML = `<div class="success">âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ #${d.data.ComplaintNo}.</div>`;
            } else {
                document.getElementById('message').innerHTML = `<div class="error">âŒ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø±Ù‚Ù… ${complaintNo} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</div>`;
            }
        } catch(e) {
            document.getElementById('message').innerHTML = `<div class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${e.message}</div>`;
        }
    } else {
        document.getElementById('message').innerHTML = `<div class="info">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰.</div>`;
    }
};

// Ø­Ø¯Ø« Ø­ÙØ¸/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById('complaintForm').onsubmit = async function(e) {
    e.preventDefault();
    const isUpdate = document.getElementById('ComplaintID').value;
    const action = isUpdate ? 'update' : 'add';

    const formData = new FormData(this);
    formData.append('action', action);
    formData.append('EmpID', currentUser.user_data.EmpID); // Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

    // ÙŠØ¬Ø¨ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ³Ù…Ø­ Ø¨Ø°Ù„Ùƒ.
    // (Ù„Ù… ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙÙŠ HTML/JS Ù„ØªØ¹Ù‚ÙŠØ¯Ù‡Ø§ØŒ Ù„ÙƒÙ†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ PHP).
    
    document.getElementById('submit_button').disabled = true;
    
    try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        const d = await res.json();
        
        if (d.success) {
            document.getElementById('message').innerHTML = `<div class="success">âœ… ${d.message}. Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: ${d.ComplaintNo || formData.get('ComplaintNo')}</div>`;
            if (!isUpdate) {
                resetForm(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©
            } else {
                loadComplaint(isUpdate); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            }
        } else {
            document.getElementById('message').innerHTML = `<div class="error">âŒ ${d.message}</div>`;
        }
    } catch(e) {
        document.getElementById('message').innerHTML = `<div class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${e.message}</div>`;
    } finally {
        document.getElementById('submit_button').disabled = false;
    }
};

// Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙˆÙ‰
document.getElementById('delete_button').onclick = async function() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;

    const id = document.getElementById('ComplaintID').value;
    const form = new FormData();
    form.append('action', 'delete');
    form.append('ComplaintID', id);

    try {
        const res = await fetch(API_URL, { method: 'POST', body: form });
        const d = await res.json();
        
        if (d.success) {
            document.getElementById('message').innerHTML = `<div class="success">âœ… ${d.message}</div>`;
            resetForm();
        } else {
            document.getElementById('message').innerHTML = `<div class="error">âŒ ${d.message}</div>`;
        }
    } catch (e) {
        document.getElementById('message').innerHTML = `<div class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ${e.message}</div>`;
    }
};

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹
document.getElementById('map-pin-btn').onclick = function() {
    const coords = document.getElementById('Coordinates').value.split(',').map(s => parseFloat(s.trim()));
    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
        map.setView(coords, 15);
        marker.setLatLng(coords);
    } else {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.');
    }
};


// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
window.onload = function() {
    loadEmployees();
    getUserRights();
    initMap(); // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
};

</script>
</body>
</html>