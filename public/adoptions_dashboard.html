<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة التبني — Adoptions (tbl_adoptions)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6faf7; --card:#fff; --accent:#2b6b3a; --danger:#d9534f; --muted:#6b7280; --radius:10px;
  font-family:"Tajawal",sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#122; -webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:20px auto;padding:16px}
.header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#27552f);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.title{font-weight:800}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.input{padding:8px 10px;border-radius:8px;border:1px solid #e9efe9;background:#fff}
.btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid #e9efe9;color:var(--muted)}
.small{font-size:0.9rem;color:var(--muted)}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(10,20,30,0.04);margin-bottom:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #f2f6f2;text-align:right;vertical-align:middle}
.thumb{width:56px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #eee}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.badge{padding:4px 8px;background:#f0ad4e;color:#3b2a00;border-radius:999px;font-weight:700}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999;visibility:hidden;opacity:0;transition:0.12s}
.modal.show{visibility:visible;opacity:1}
.modalCard{width:100%;max-width:820px;background:#fff;border-radius:10px;padding:14px}
.formRow{display:flex;gap:8px;flex-wrap:wrap}
.label{font-weight:700;margin-bottom:6px}
textarea.input{min-height:110px}
@media(max-width:900px){ .header{flex-wrap:wrap} .controls{margin-left:0} .formRow{flex-direction:column} }
</style>
</head>
<body>
<div class="container" role="application" aria-label="لوحة تبني">
  <div class="header">
    <div class="logo">AD</div>
    <div>
      <div class="title">سجل التبني — tbl_adoptions</div>
      <div class="small">جلب البيانات عبر: /health_vet/api/get_data.php?resource=adoptions أو ?table=tbl_adoptions</div>
    </div>

    <div class="controls" role="region" aria-label="بحث وتحكم">
      <input id="searchInput" class="input" placeholder="بحث بـ الكود / اسم المتبني / رقم الهاتف / إيصال..." />
      <select id="filterOp" class="input" style="min-width:140px">
        <option value="">كل الحالات</option>
        <option value="adopted">adopted</option>
        <option value="reserved">reserved</option>
      </select>
      <button id="btnSearch" class="btn">بحث</button>
      <button id="btnRefresh" class="btn btn.ghost">تحديث</button>
      <button id="btnExport" class="btn btn.ghost">تصدير CSV</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>قائمة التبني</strong> <span id="summary" class="small"></span></div>
      <div class="small">صفحة <span id="pageNum">1</span></div>
    </div>

    <div style="margin-top:10px;overflow:auto;">
      <table class="table" id="adoptionsTable" aria-live="polite">
        <thead>
          <tr>
            <th>#</th>
            <th>رمز الحيوان</th>
            <th>المتبني</th>
            <th>هاتف</th>
            <th>تاريخ</th>
            <th>إيصال</th>
            <th>الحالة</th>
            <th class="no-print">أوامر</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="small">جارٍ التحميل ...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pager">
      <div class="small">إظهار</div>
      <select id="perPage" class="input" style="width:80px">
        <option>10</option><option>25</option><option>50</option><option>100</option>
      </select>
      <button id="prevBtn" class="btn btn.ghost">السابق</button>
      <button id="nextBtn" class="btn">التالي</button>
    </div>
  </div>
</div>

<!-- modal details -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="modalClose" class="btn btn.ghost">إغلاق</button>
    </div>
  </div>
</div>

<script>
/*
  adoptions_dashboard.html
  - This page uses unified API get_data.php focused on tbl_adoptions.
  - Endpoints used:
      GET  /health_vet/api/get_data.php?resource=adoptions&page=..&per_page=..&q=...&operation_type=...
      GET  /health_vet/api/get_data.php?single=1&id=...
      POST /health_vet/api/process_adoption.php  (action=approve|reserve|reject, adoption_id)
  - Make sure get_data.php is the file you installed on the server and returns JSON {success:true, page, per_page, total, data:[]}
*/

const API = '/health_vet/api/get_data.php';
const PROCESS_API = '/health_vet/api/process_adoption.php';
const tbody = document.getElementById('tbody');
const searchInput = document.getElementById('searchInput');
const filterOp = document.getElementById('filterOp');
const perPageSelect = document.getElementById('perPage');
let page = 1, per_page = parseInt(perPageSelect.value), total = 0;

document.getElementById('btnSearch').addEventListener('click', ()=> { page = 1; loadList(); });
document.getElementById('btnRefresh').addEventListener('click', ()=> loadList());
document.getElementById('nextBtn').addEventListener('click', ()=> { if (page * per_page < total) { page++; loadList(); }});
document.getElementById('prevBtn').addEventListener('click', ()=> { if (page > 1) { page--; loadList(); }});
perPageSelect.addEventListener('change', ()=> { per_page = parseInt(perPageSelect.value); page = 1; loadList(); });
document.getElementById('modalClose').addEventListener('click', hideModal);
document.getElementById('btnExport').addEventListener('click', exportCSV);

// initial load
loadList();

async function loadList(){
  showLoading();
  const q = encodeURIComponent(searchInput.value.trim());
  const op = filterOp.value;
  const url = `${API}?resource=adoptions&page=${page}&per_page=${per_page}${q?('&q='+q):''}${op?('&operation_type='+encodeURIComponent(op)):''}`;
  try {
    const res = await fetch(url, { credentials:'same-origin' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    if (!j.success) throw new Error(j.message || 'خطأ في الخادم');
    renderTable(j.data || [], j.page || page, j.per_page || per_page, j.total || 0);
  } catch(err){
    tbody.innerHTML = `<tr><td colspan="8" class="small" style="color:crimson">فشل جلب البيانات: ${escapeHtml(err.message)}</td></tr>`;
    console.error(err);
  }
}

function renderTable(rows, p, pp, tot){
  page = p; per_page = pp; total = tot;
  document.getElementById('pageNum').textContent = page;
  document.getElementById('summary').textContent = `إجمالي السجلات: ${total}`;
  if (!rows || !rows.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="small">لا توجد سجلات</td></tr>`; return;
  }
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const id = r.adoption_id ?? r.id ?? '';
    const animal = r.animal_code ?? '';
    const name = r.adopter_name ?? '';
    const phone = r.adopter_phone ?? '';
    const date = r.adoption_date ?? (r.created_at ? r.created_at.split(' ')[0] : '');
    const receipt = r.receipt_number ?? r.receipt ?? '';
    const op = r.Operation_type ?? r.operation ?? '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(id)}</td>
                    <td>${escapeHtml(animal)}</td>
                    <td>${escapeHtml(name)}</td>
                    <td>${escapeHtml(phone)}</td>
                    <td>${escapeHtml(date)}</td>
                    <td>${escapeHtml(receipt)}</td>
                    <td><span class="badge">${escapeHtml(op)}</span></td>
                    <td class="no-print">
                      <button class="btn btn.ghost" onclick="showDetails('${escapeJs(id)}')">عرض</button>
                      <button class="btn" onclick="process('${escapeJs(id)}','approve')">اعتماد</button>
                      <button class="btn btn.ghost" onclick="process('${escapeJs(id)}','reserve')">حجز</button>
                      <button class="btn btn.ghost" onclick="process('${escapeJs(id)}','reject')">رفض</button>
                    </td>`;
    tbody.appendChild(tr);
  });
}

function showLoading(){
  tbody.innerHTML = `<tr><td colspan="8" class="small">جارٍ التحميل ...</td></tr>`;
}

// show modal with single record details
async function showDetails(id){
  const url = `/health_vet/api/get_data.php?single=1&id=${encodeURIComponent(id)}`;
  try {
    const res = await fetch(url, { credentials:'same-origin' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    if (!j.success) throw new Error(j.message || 'خطأ');
    const r = j.data;
    if (!r) {
      showModal(`<div class="small">السجل غير موجود</div>`);
      return;
    }
    const html = `
      <h3>تفاصيل التبني #${escapeHtml(r.adoption_id ?? r.id ?? '')}</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1"><div class="label">رمز الحيوان</div><div>${escapeHtml(r.animal_code ?? '')}</div></div>
        <div style="flex:1"><div class="label">المتبني</div><div>${escapeHtml(r.adopter_name ?? '')}</div></div>
        <div style="flex:1"><div class="label">هاتف</div><div>${escapeHtml(r.adopter_phone ?? '')}</div></div>
      </div>
      <div style="margin-top:8px"><div class="label">البريد</div><div>${escapeHtml(r.adopter_email ?? '')}</div></div>
      <div style="margin-top:8px"><div class="label">تاريخ التبني</div><div>${escapeHtml(r.adoption_date ?? r.created_at ?? '')}</div></div>
      <div style="margin-top:8px"><div class="label">الحالة</div><div>${escapeHtml(r.Operation_type ?? '')}</div></div>
      <div style="margin-top:8px"><div class="label">إيصال الدفع</div><div>${escapeHtml(r.receipt_number ?? '')}</div></div>
      <div style="margin-top:12px"><div class="label">الملاحظات</div><div><textarea class="input" id="notesField">${escapeHtml(r.notes ?? '')}</textarea></div></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn.ghost" onclick="closeModal()">إغلاق</button>
        <button class="btn" onclick="saveNotes('${escapeJs(id)}')">حفظ الملاحظات</button>
      </div>`;
    showModal(html);
  } catch(err){
    showModal(`<div class="small" style="color:crimson">فشل جلب التفاصيل: ${escapeHtml(err.message)}</div>`);
    console.error(err);
  }
}

function showModal(html){ const m=document.getElementById('modal'); document.getElementById('modalContent').innerHTML = html; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
function hideModal(){ const m=document.getElementById('modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
function closeModal(){ hideModal(); }

// save notes (simple update via process_adoption.php append note)
async function saveNotes(id){
  const notes = document.getElementById('notesField').value || '';
  // We'll append a note using process_adoption.php action=note (if supported); otherwise use reject/approve as appropriate
  try {
    const fd = new FormData();
    fd.set('action','note');
    fd.set('adoption_id', id);
    fd.set('notes', notes);
    const res = await fetch(PROCESS_API, { method:'POST', body: fd, credentials:'same-origin' });
    const j = await res.json();
    if (!j.success) throw new Error(j.message || 'فشل الحفظ');
    alert('تم حفظ الملاحظات');
    closeModal();
    loadList();
  } catch(err){
    alert('فشل حفظ الملاحظات: ' + (err.message || ''));
  }
}

// process adoption actions (approve/reserve/reject)
async function process(id, action){
  if (!confirm(`تأكيد تنفيذ "${action}" على السجل #${id}؟`)) return;
  const fd = new FormData();
  fd.set('action', action);
  fd.set('adoption_id', id);
  try {
    const res = await fetch(PROCESS_API, { method:'POST', body: fd, credentials:'same-origin' });
    const j = await res.json();
    if (!j.success) throw new Error(j.message || 'Server error');
    alert(j.message || 'تمت العملية');
    loadList();
  } catch(err){
    alert('فشل: ' + (err.message || ''));
    console.error(err);
  }
}

// export current page to CSV
function exportCSV(){
  // create CSV from current table rows
  const rows = Array.from(document.querySelectorAll('#adoptionsTable thead tr, #adoptionsTable tbody tr')).map(tr=>{
    return Array.from(tr.querySelectorAll('th,td')).map(td => td.innerText.replace(/\n/g,' ').trim());
  });
  const csv = rows.map(r => r.map(c=> `"${String(c).replace(/"/g,'""')}"` ).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `adoptions_page_${page}.csv`; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
}

// small helpers
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeJs(s){ if (s==null) return ''; return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }

// initial utilities: close modal on outside click
document.addEventListener('click', (e)=> {
  const modal = document.getElementById('modal');
  if (!modal.classList.contains('show')) return;
  if (!e.target.closest('.modalCard')) { hideModal(); }
});
</script>
</body>
</html>