<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…ØªÙƒØ§Ù…Ù„Ø© â€” HealthVet (Final - Fixed Search & Stats)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f8f5;
  --card:#fff;
  --accent:#2b6b3a;
  --accent-2:#c79b3c;
  --danger:#d9534f;
  --warning:#f0ad4e;
  --success:#28a745;
  --muted:#6b7280;
  --radius:12px;
  font-family:"Tajawal", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);-webkit-font-smoothing:antialiased;color:#111}
.container{max-width:1300px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#29552f);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
.h-title{font-weight:800;font-size:1.15rem}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.search{padding:8px 12px;border-radius:10px;border:1px solid #e9efe9;background:#fff;min-width:220px}
.iconBtn{border:0;background:#fff;padding:8px;border-radius:10px;cursor:pointer;box-shadow:0 3px 10px rgba(15,23,42,0.04)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:16px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 10px 30px rgba(10,20,30,0.04)}
.kpi .num{font-weight:800;font-size:1.6rem}
.kpi .label{color:var(--muted);font-size:0.95rem}
.kpi.danger .num{color:var(--danger)}
.kpi.warning .num{color:var(--warning)}
.kpi.success .num{color:var(--success)}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
.leftCol{display:grid;gap:14px}
.sectionTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.small{font-size:0.92rem;color:var(--muted)}
.tableWrap{overflow:auto;border-radius:10px;border:1px solid #f0f2f0;background:#fff;padding:8px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #f3f5f4;text-align:right;vertical-align:middle}
.thumb{width:56px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #eee}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--accent-2);color:#231;font-weight:700}
.alert{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff8e6,#fffdf6);border:1px solid rgba(199,155,60,0.12);color:#6b4b10}
.rightCol{display:flex;flex-direction:column;gap:14px}
/* collapsible sections */
.collapsible-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: 0 10px 30px rgba(10,20,30,0.04);
  overflow: hidden;
}
.collapsible-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  cursor: pointer;
  background: var(--card);
  border-bottom: 1px solid #f0f2f0;
  font-weight: 700;
}
.collapsible-content {
  padding: 0 14px 14px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}
.collapsible-content.show {
  max-height: 2000px; /* adjust as needed */
  padding: 14px;
}
.toggle-btn {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  color: var(--muted);
  transition: transform 0.3s;
}
.toggle-btn.rotated {
  transform: rotate(180deg);
}
/* filters */
.filters {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.filters select, .filters input {
  padding: 6px 8px;
  border: 1px solid #e8efe8;
  border-radius: 6px;
  font-size: 0.9rem;
}
.section-search {
  margin-bottom: 12px;
}
.section-search input {
  width: 100%;
  padding: 8px;
  border: 1px solid #e8efe8;
  border-radius: 6px;
}
/* stats */
.stats-row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}
.stats-row .stat {
  flex: 1;
  text-align: center;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 8px;
}
/* notifications */
.notifications {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  max-width: 300px;
}
.toast {
  background: var(--danger);
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  animation: slideIn 0.3s ease-out;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.success { background: var(--success); }
.toast.warning { background: var(--warning); }
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
/* responsive */
@media(max-width:1100px){ .kpis{grid-template-columns:repeat(2,1fr)} .grid{grid-template-columns:1fr} .controls{width:100%;justify-content:space-between} }
@media(max-width:640px){ .search{min-width:140px} .header{flex-wrap:wrap} .filters { flex-direction: column; } }
/* modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999;visibility:hidden;opacity:0;transition:0.12s}
.modal.show{visibility:visible;opacity:1}
.modalCard{width:100%;max-width:920px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 30px 80px rgba(13,25,42,0.2)}
.input,select,textarea{font-family:inherit;padding:8px;border-radius:8px;border:1px solid #e8efe8;width:100%}
.btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid #e6e6e6;color:var(--muted)}
.btn.adopt { background: var(--accent-2); }
</style>
</head>
<body>
<div class="container" role="application" aria-label="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… HealthVet Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©">
  <header class="header" role="banner">
    <div class="logo">HV</div>
    <div>
      <div class="h-title">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…ØªÙƒØ§Ù…Ù„Ø© â€” HealthVet</div>
      <div class="small">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø©: Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§ØªØŒ Ø§Ù„ØªØ¨Ù†ÙŠØŒ Ø§Ù„ØºØ±ÙØŒ Ø§Ù„Ø­Ø±ÙƒØ§ØªØŒ Ø§Ù„Ø²ÙˆØ§Ø± ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
    </div>
    <div class="controls" role="region" aria-label="Controls">
      <input id="globalSearch" class="search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹: Ù…Ù†ØªØ¬ / Ø­ÙŠÙˆØ§Ù† / ØªØ¨Ù†ÙŠ / Ø²Ø§Ø¦Ø±..." />
      <button id="btnScan" class="iconBtn" title="Ù…Ø³Ø­ QR">ğŸ“·</button>
      <button id="btnRefresh" class="iconBtn" title="ØªØ­Ø¯ÙŠØ«">ğŸ”„</button>
      <button id="btnCleanup" class="iconBtn" title="ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Cron)">ğŸ§¹</button>
    </div>
  </header>
  <!-- Notifications Container -->
  <div id="notifications" class="notifications"></div>
  <section class="kpis" aria-label="KPIs">
    <div class="card kpi" id="kpi-products">
      <div class="num" id="k_total_products">--</div>
      <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    </div>
    <div class="card kpi" id="kpi-low">
      <div class="num" id="k_low_stock">--</div>
      <div class="label">Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©</div>
    </div>
    <div class="card kpi" id="kpi-visits">
      <div class="num" id="k_today_visits">--</div>
      <div class="label">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
    </div>
    <div class="card kpi" id="kpi-animals">
      <div class="num" id="k_animals_total">--</div>
      <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</div>
    </div>
  </section>
  <main class="grid" aria-live="polite">
    <div class="leftCol">
      <!-- Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('stockSection')">
          <div>
            <strong>Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</strong>
            <div class="small">Ø§Ù„ÙƒÙ…ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (MinQuantity)</div>
          </div>
          <div class="small">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastRef">--</span></div>
          <button class="toggle-btn" id="toggleStock">â–¼</button>
        </div>
        <div id="stockSection" class="collapsible-content">
          <div class="section-search">
            <input type="text" id="searchProducts" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..." oninput="renderAllProducts()">
          </div>
          <div style="display:flex;gap:12px;margin-bottom:12px">
            <div style="flex:1;padding:12px;background:#fff;border-radius:10px">
              <canvas id="chart_cat" height="140"></canvas>
            </div>
            <div style="flex:1;padding:12px;background:#fff;border-radius:10px">
              <canvas id="chart_status" height="140"></canvas>
            </div>
          </div>
          <div class="sectionTitle"><strong>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</strong></div>
          <div class="tableWrap">
            <table class="table" id="allProductsTable" aria-label="all-products-table">
              <thead><tr><th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Min</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody><tr><td colspan="5" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('visitsSection')">
          <div><strong>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</strong><div class="small">ÙØªØ­/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</div></div>
          <button class="toggle-btn" id="toggleVisits">â–¼</button>
        </div>
        <div id="visitsSection" class="collapsible-content">
          <div class="section-search">
            <input type="text" id="searchVisits" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª..." oninput="renderVisits()">
          </div>
          <div class="tableWrap">
            <table class="table" id="visitsTable">
              <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø±Ù…Ø² Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th class="no-print">ÙØªØ­</th></tr></thead>
              <tbody><tr><td colspan="5" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('movementsSection')">
          <div><strong>Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</strong><div class="small">In / Out / Transfer / TemporaryOut</div></div>
          <button class="toggle-btn" id="toggleMovements">â–¼</button>
        </div>
        <div id="movementsSection" class="collapsible-content">
          <div class="filters">
            <input type="text" id="filterMovementsAnimal" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†" oninput="renderMovements()">
          </div>
          <div class="section-search">
            <input type="text" id="searchMovements" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª..." oninput="renderMovements()">
          </div>
          <div class="tableWrap">
            <table class="table" id="movementsTable">
              <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø­ÙŠÙˆØ§Ù†</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th class="no-print">Ù…Ù„Ø§Ø­Ø¸Ø©</th><th class="no-print">ÙØªØ­</th></tr></thead>
              <tbody><tr><td colspan="6" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <aside class="rightCol">
      <!-- Ø§Ù„ØºØ±Ù - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('roomsSection')">
          <div><strong>Ø§Ù„ØºØ±Ù</strong><div class="small">Ø§Ù„Ø³Ø¹Ø© ÙˆØ§Ù„Ø¥Ø´ØºØ§Ù„</div></div>
          <button class="toggle-btn" id="toggleRooms">â–¼</button>
        </div>
        <div id="roomsSection" class="collapsible-content">
          <div class="filters">
            <select id="filterRoomsType" onchange="renderRooms()">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
              <option value="cats">Ù‚Ø·Ø·</option>
              <option value="dogs">ÙƒÙ„Ø§Ø¨</option>
            </select>
            <input type="text" id="filterRoomsAnimal" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†" oninput="renderRooms()">
          </div>
          <div class="section-search">
            <input type="text" id="searchRooms" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØºØ±Ù..." oninput="renderRooms()">
          </div>
          <div class="stats-row">
            <div class="stat"><strong id="statsRoomsCats">--</strong><small>ØºØ±Ù Ù‚Ø·Ø·</small></div>
            <div class="stat"><strong id="statsRoomsDogs">--</strong><small>ØºØ±Ù ÙƒÙ„Ø§Ø¨</small></div>
          </div>
          <div class="tableWrap">
            <table class="table" id="roomsTable">
              <thead><tr><th>Ø§Ù„ØºØ±ÙØ©</th><th>Ø§Ù„Ø³Ø¹Ø©</th><th>Ø§Ù„Ø¥Ø´ØºØ§Ù„</th><th>ÙƒÙ„Ø§Ø¨/Ù‚Ø·Ø·</th><th class="no-print">ÙØªØ­</th></tr></thead>
              <tbody><tr><td colspan="5" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('animalsSection')">
          <div><strong>Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</strong><div class="small">ÙØªØ­ Ø³Ø¬Ù„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</div></div>
          <button class="toggle-btn" id="toggleAnimals">â–¼</button>
        </div>
        <div id="animalsSection" class="collapsible-content">
          <div class="filters">
            <select id="filterAnimalsType" onchange="renderAnimals()">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
              <option value="cats">Ù‚Ø·Ø·</option>
              <option value="dogs">ÙƒÙ„Ø§Ø¨</option>
              <option value="other">Ø£Ø®Ø±Ù‰</option>
            </select>
            <select id="filterAnimalsStatus" onchange="renderAnimals()">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="active">Ù†Ø´Ø·</option>
              <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
            </select>
            <input type="text" id="filterAnimalsCode" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†" oninput="renderAnimals()">
          </div>
          <div class="section-search">
            <input type="text" id="searchAnimals" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª..." oninput="renderAnimals()">
          </div>
          <div class="tableWrap">
            <table class="table" id="animalsTable">
              <thead><tr><th>Ø±Ù…Ø²</th><th>Ø§Ø³Ù…</th><th>Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="no-print">ÙØªØ­</th></tr></thead>
              <tbody><tr><td colspan="5" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Ø³Ø¬Ù„ Ø§Ù„ØªØ¨Ù†ÙŠ - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('adoptionsSection')">
          <div><strong>Ø³Ø¬Ù„ Ø§Ù„ØªØ¨Ù†ÙŠ (tbl_adoptions)</strong><div class="small">Ø§Ø¹ØªÙ…Ø§Ø¯/Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹</div></div>
          <button class="toggle-btn" id="toggleAdoptions">â–¼</button>
        </div>
        <div id="adoptionsSection" class="collapsible-content">
          <div class="filters">
            <select id="filterAdoptionsType" onchange="renderAdoptions()">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
              <option value="cats">Ù‚Ø·Ø·</option>
              <option value="dogs">ÙƒÙ„Ø§Ø¨</option>
            </select>
            <select id="filterAdoptionsOperation" onchange="renderAdoptions()">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
              <option value="adopt">ØªØ¨Ù†ÙŠ</option>
              <option value="reserve">Ø­Ø¬Ø²</option>
            </select>
          </div>
          <div class="section-search">
            <input type="text" id="searchAdoptions" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªØ¨Ù†ÙŠ..." oninput="renderAdoptions()">
          </div>
          <div class="stats-row">
            <div class="stat"><strong id="statsAdoptionsAdopt">--</strong><small>ØªØ¨Ù†ÙŠ</small></div>
            <div class="stat"><strong id="statsAdoptionsReserve">--</strong><small>Ø­Ø¬ÙˆØ²Ø§Øª</small></div>
          </div>
          <div class="tableWrap">
            <table class="table" id="adoptionsTable">
              <thead><tr><th>#</th><th>Ø­ÙŠÙˆØ§Ù†</th><th>Ø§Ù„Ù…ØªØ¨Ù†ÙŠ</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
              <tbody><tr><td colspan="6" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¨Ù†ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('applicationsSection')">
          <div><strong>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¨Ù†ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</strong><div class="small">approved_by = null</div></div>
          <button class="toggle-btn" id="toggleApplications">â–¼</button>
        </div>
        <div id="applicationsSection" class="collapsible-content">
          <div class="section-search">
            <input type="text" id="searchApplications" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª..." oninput="renderApplications()">
          </div>
          <div id="applicationsList" class="tableWrap"><div class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>
      </div>
      <!-- Ø§Ù„Ø²ÙˆØ§Ø± ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… - Collapsible -->
      <div class="collapsible-card">
        <div class="collapsible-header" onclick="toggleSection('incomingSection')">
          <div><strong>Ø§Ù„Ø²ÙˆØ§Ø± ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</strong></div>
          <button class="toggle-btn" id="toggleIncoming">â–¼</button>
        </div>
        <div id="incomingSection" class="collapsible-content">
          <div class="small">Ø§Ù„Ø²ÙˆØ§Ø±: <strong id="vis_total">--</strong> Â· Ø§Ù„ÙŠÙˆÙ…: <strong id="vis_today">--</strong></div>
          <div class="section-search">
            <input type="text" id="searchIncoming" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©..." oninput="renderIncoming()">
          </div>
          <div style="margin-top:8px" class="tableWrap">
            <table class="table" id="incomingTable">
              <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø·Ù„Ø¨Ø§Øª</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
              <tbody><tr><td colspan="3" class="small">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </aside>
  </main>
</div>
<!-- modal structure -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true">
    <div id="modalBody"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="modalClose" class="btn btn.ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>
<!-- scanner modal -->
<div id="scanModal" class="modal" aria-hidden="true">
  <div class="modalCard" style="max-width:760px">
    <h3 style="margin:0 0 8px 0">Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ø­ÙŠÙˆØ§Ù†</h3>
    <div style="background:#000;border-radius:8px;padding:6px">
      <video id="scanVideo" autoplay playsinline style="width:100%;border-radius:6px;display:block"></video>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="closeScan" class="btn btn.ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>
    <script src="session_check.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
/*
  Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø¨Ø­Ø« Ù…Ø­Ù„ÙŠ ÙÙŠ ÙƒÙ„ Ù‚Ø³Ù… ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©.
  - Ø¥Ø¶Ø§ÙØ© Ø¨Ø­Ø« Ù…Ø­Ù„ÙŠ (section-search) Ù„ÙƒÙ„ Ù‚Ø³Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©.
  - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ØªØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©ØŒ Ù…Ø¹ console.log Ù„Ù„ØªØµØ­ÙŠØ­.
  - Ø¥Ø¶Ø§ÙØ© error handling ÙÙŠ loaders Ù…Ø¹ toast Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.
  - ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± Ù„ØªØ´Ù…Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.
*/
const API_BASE = '/health_vet/api/';
const GET_DATA = API_BASE + 'get_data.php';
const $ = id => document.getElementById(id);
let chartCat = null, chartStatus = null;
let products = [], rooms = [], animals = [], visits = [], adoptions = [], movements = [], applications = [], incoming = [], visitorsSummary = null;
const LOW_STOCK_THRESHOLD = 5;
const RESERVE_THRESHOLD = 10;
const VISIT_THRESHOLD = 20;
document.addEventListener('DOMContentLoaded', () => {
  bindUI();
  refreshAll();
});
function bindUI(){
  $('btnRefresh').addEventListener('click', refreshAll);
  $('modalClose').addEventListener('click', hideModal);
  $('globalSearch').addEventListener('keydown', e => { if (e.key === 'Enter') quickSearch(); });
  $('btnScan').addEventListener('click', openScanModal);
  $('closeScan')?.addEventListener('click', closeScanModal);
  $('btnCleanup').addEventListener('click', runCleanupReservations);
}
/* ---------- collapsible sections ---------- */
function toggleSection(sectionId) {
  const content = $(sectionId);
  const btn = $(`toggle${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
  content.classList.toggle('show');
  if (btn) btn.classList.toggle('rotated');
}
/* ---------- utility fetch helpers ---------- */
async function safeFetchJson(path) {
  try {
    const res = await fetch(API_BASE + path, { credentials:'same-origin' });
    if (!res.ok) { showToast(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ${path}: ${res.status}`, 'danger'); return null; }
    return await res.json().catch(()=> { showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'danger'); return null; });
  } catch (e) { console.error(e); showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'danger'); return null; }
}
async function fetchGetDataResource(resource, page=1, per_page=200, q='') {
  try {
    const url = new URL(GET_DATA, location.origin);
    url.searchParams.set('resource', resource);
    url.searchParams.set('page', page);
    url.searchParams.set('per_page', per_page);
    if (q) url.searchParams.set('q', q);
    const res = await fetch(url.toString(), { credentials:'same-origin' });
    if (!res.ok) { showToast(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ${resource}: ${res.status}`, 'danger'); return null; }
    const j = await res.json().catch(()=> { showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'danger'); return null; });
    if (!j) return null;
    if (Array.isArray(j)) return { success:true, data:j };
    if (j.success === true && Array.isArray(j.data)) return j;
    if (j.data && Array.isArray(j.data)) return j;
    return null;
  } catch(e){ console.error(e); showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'danger'); return null; }
}
/* ---------- notifications ---------- */
function showToast(message, type = 'danger') {
  const container = $('notifications');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `âš ï¸ ${escapeHtml(message)}`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}
/* ---------- main refresh flow ---------- */
async function refreshAll(){
  console.log('Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
  $('lastRef').textContent = new Date().toLocaleString();
  await Promise.all([
    loadProducts(),
    loadAdoptions(),
    loadAnimals(),
    loadVisits(),
    loadMovements(),
    loadRooms(),
    loadApplications(),
    loadIncomingRequests(),
    loadVisitorsSummary()
  ]);
  console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', { products: products.length, animals: animals.length, visits: visits.length, adoptions: adoptions.length });
  renderAll();
  checkAlerts();
}
/* ---------- loaders with better logging ---------- */
async function loadProducts(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
  const j = await safeFetchJson('get_products.php?lang=ar&per_page=500&q=');
  if (j && j.success && Array.isArray(j.data)) { products = j.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', products.length, 'Ù…Ù†ØªØ¬'); return; }
  products = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
}
async function loadAdoptions(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨Ù†ÙŠ...');
  const j = await fetchGetDataResource('adoptions',1,500,'');
  if (j && j.success && Array.isArray(j.data)) { adoptions = j.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', adoptions.length, 'Ø³Ø¬Ù„ ØªØ¨Ù†ÙŠ'); return; }
  const altPaths = ['get_adoptions.php','get_adoptions_list.php','get_adoptions_all.php','get_adoptions_table.php','get_table.php?name=tbl_adoptions'];
  for (const p of altPaths) {
    const r = await safeFetchJson(p);
    if (!r) continue;
    if (Array.isArray(r)) { adoptions = r; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¹Ø¨Ø± Ø¨Ø¯ÙŠÙ„:', adoptions.length); break; }
    if (r.success && Array.isArray(r.data)) { adoptions = r.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¹Ø¨Ø± Ø¨Ø¯ÙŠÙ„:', adoptions.length); break; }
    if (Array.isArray(r.data)) { adoptions = r.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¹Ø¨Ø± Ø¨Ø¯ÙŠÙ„:', adoptions.length); break; }
  }
  if (!adoptions.length) {
    console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨Ù†ÙŠ');
  }
}
async function loadAnimals(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª...');
  const j = await fetchGetDataResource('animals',1,500,'');
  if (j && j.success && Array.isArray(j.data)) { animals = j.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', animals.length, 'Ø­ÙŠÙˆØ§Ù†'); return; }
  const alt = await safeFetchJson('get_animals.php');
  if (alt && alt.success && Array.isArray(alt.data)) { animals = alt.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', animals.length, 'Ø­ÙŠÙˆØ§Ù†'); return; }
  animals = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª');
}
async function loadVisits(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª...');
  const r = await safeFetchJson('add_visit.php?action=get_all');
  if (r && r.success && Array.isArray(r.visits)) { visits = r.visits; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', visits.length, 'Ø²ÙŠØ§Ø±Ø©'); return; }
  visits = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª');
}
async function loadMovements(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª...');
  const j = await fetchGetDataResource('animal_movements',1,500,'');
  if (j && j.success && Array.isArray(j.data)) { movements = j.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', movements.length, 'Ø­Ø±ÙƒØ©'); return; }
  const alt = await safeFetchJson('get_animal_movements.php');
  if (alt && alt.success && Array.isArray(alt.data)) { movements = alt.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', movements.length, 'Ø­Ø±ÙƒØ©'); return; }
  movements = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª');
}
async function loadRooms(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...');
  const j = await fetchGetDataResource('rooms',1,500,'');
  if (j && j.success && Array.isArray(j.data)) { rooms = j.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', rooms.length, 'ØºØ±ÙØ©'); return; }
  const alt = await safeFetchJson('get_rooms_status.php');
  if (alt && alt.success && Array.isArray(alt.rooms)) { rooms = alt.rooms; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', rooms.length, 'ØºØ±ÙØ©'); return; }
  rooms = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù');
}
async function loadApplications(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...');
  const r = await safeFetchJson('get_adoption_applications_pending.php');
  if (r && r.success && Array.isArray(r.data)) { applications = r.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', applications.length, 'Ø·Ù„Ø¨'); return; }
  applications = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
}
async function loadIncomingRequests(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©...');
  const r = await safeFetchJson('get_incoming_requests_summary.php');
  if (r && r.success && Array.isArray(r.data)) { incoming = r.data; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', incoming.length, 'Ø·Ù„Ø¨ ÙˆØ§Ø±Ø¯'); return; }
  incoming = [];
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©');
}
async function loadVisitorsSummary(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø²ÙˆØ§Ø±...');
  const r = await safeFetchJson('get_visitors_summary.php');
  if (r && r.success) { visitorsSummary = r; console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø²ÙˆØ§Ø±'); return; }
  visitorsSummary = null;
  console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø²ÙˆØ§Ø±');
}
/* ---------- renderers with local search ---------- */
function renderAll(){
  renderKPIs();
  renderAllProducts();
  renderProductsCharts();
  renderVisits();
  renderAnimals();
  renderAdoptions();
  renderMovements();
  renderRooms();
  renderApplications();
  renderIncoming();
  renderVisitors();
}
function renderKPIs(){
  const totalProducts = products.length || 0;
  const lowStock = products.filter(p => (p.Quantity ?? 0) <= (p.MinQuantity ?? 0)).length;
  const today = new Date().toISOString().slice(0,10);
  const todayVisits = visits.filter(v => (v.visit_date||'').slice(0,10) === today).length;
  const totalAnimals = animals.length || 0;

  console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª KPIs:', { totalProducts, lowStock, todayVisits, totalAnimals });

  $('k_total_products').textContent = totalProducts;
  $('k_low_stock').textContent = lowStock;
  $('k_today_visits').textContent = todayVisits;
  $('k_animals_total').textContent = totalAnimals;

  // Ø£Ù„ÙˆØ§Ù† KPIs
  const kpiLow = $('kpi-low');
  kpiLow.className = 'card kpi';
  if (lowStock > LOW_STOCK_THRESHOLD) kpiLow.classList.add('danger');
  else if (lowStock > 0) kpiLow.classList.add('warning');
  else kpiLow.classList.add('success');

  const kpiVisits = $('kpi-visits');
  kpiVisits.className = 'card kpi';
  if (todayVisits > VISIT_THRESHOLD) kpiVisits.classList.add('danger');
  else if (todayVisits > 10) kpiVisits.classList.add('warning');
  else kpiVisits.classList.add('success');
}
function getFilteredProducts() {
  let filtered = products;
  const search = $('searchProducts')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(p => 
      (p.Name_AR || '').toLowerCase().includes(search) ||
      (p.Name_EN || '').toLowerCase().includes(search) ||
      String(p.Product_Code || '').toLowerCase().includes(search) ||
      String(p.Quantity || '').includes(search)
    );
  }
  return filtered.sort((a,b)=> (b.Quantity || 0) - (a.Quantity || 0));
}
function renderAllProducts(){
  const tbody = document.querySelector('#allProductsTable tbody');
  tbody.innerHTML = '';
  const filtered = getFilteredProducts();
  if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="5" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }
  filtered.forEach(p=>{
    const img = p.ProductImage ? `<img src="/health_vet/uploads/ProductImage/${p.ProductImage}" class="thumb">` : '-';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${img}</td><td>${escapeHtml(p.Name_AR||p.Name_EN||p.Product_Code||'')}</td><td>${p.Quantity||0}</td><td>${p.MinQuantity||0}</td>
                    <td class="no-print">
                      <button class="btn btn.ghost" onclick="openProduct(${p.Product_ID||p.ProductId||p.id||0})">Ø¹Ø±Ø¶</button>
                    </td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function renderProductsCharts(){
  try {
    const map = {};
    products.forEach(p => { const k = p.InventoryItemID ?? '0'; map[k] = (map[k]||0) + (p.Quantity||0); });
    const entries = Object.entries(map).sort((a,b)=> b[1]-a[1]).slice(0,6);
    const labels = entries.map(e => `ÙØ¦Ø© ${e[0]}`);
    const data = entries.map(e => e[1]);
    const ctx1 = document.getElementById('chart_cat').getContext('2d');
    if (chartCat) chartCat.destroy();
    chartCat = new Chart(ctx1, { type:'bar', data:{ labels, datasets:[{ label:'ÙƒÙ…ÙŠØ©', data, backgroundColor:['#6baf8a','#4c9f70','#2b8f60','#c79b3c','#f3a94b','#7aa0d9'] }]}, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}} });
    const enough = products.filter(p => (p.Quantity||0) > (p.MinQuantity||0)).length;
    const low = products.filter(p => (p.Quantity||0) > 0 && (p.Quantity||0) <= (p.MinQuantity||0)).length;
    const out = products.filter(p => (p.Quantity||0) <= 0).length;
    const ctx2 = document.getElementById('chart_status').getContext('2d');
    if (chartStatus) chartStatus.destroy();
    chartStatus = new Chart(ctx2, { type:'doughnut', data:{ labels:['ÙƒØ§ÙÙŠ','Ù…Ù†Ø®ÙØ¶','Ù†ÙØ¯'], datasets:[{ data:[enough,low,out], backgroundColor:['#28a745','#f0ad4e','#d9534f'] }]}, options:{plugins:{legend:{position:'bottom'}}} });
    console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©');
  } catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©:', e); }
}
function getFilteredVisits() {
  let filtered = visits;
  const search = $('searchVisits')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(v => 
      (v.visit_date || '').toLowerCase().includes(search) ||
      (v.animal_code || '').toLowerCase().includes(search) ||
      (v.doctor_name || v.doctor_empid || '').toLowerCase().includes(search) ||
      (v.visit_type || '').toLowerCase().includes(search)
    );
  }
  return filtered.slice().sort((a,b)=> new Date(b.visit_date)-new Date(a.visit_date)).slice(0,20);
}
function renderVisits(){
  const tbody = document.querySelector('#visitsTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredVisits();
  if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="5" class="small">Ù„Ø§ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }
  filtered.forEach(v=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(v.visit_date || '')}</td><td>${escapeHtml(v.animal_code||'')}</td><td>${escapeHtml(v.doctor_name||v.doctor_empid||'')}</td><td>${escapeHtml(v.visit_type||'')}</td><td class="no-print"><button class="btn btn.ghost" onclick="openVisit(${v.id||v.VisitID||0})">ÙØªØ­</button></td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ø²ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function getFilteredAnimals() {
  let filtered = animals;
  const type = $('filterAnimalsType')?.value;
  if (type) filtered = filtered.filter(a => (a.animal_type || '').toLowerCase().includes(type));
  const status = $('filterAnimalsStatus')?.value;
  if (status) filtered = filtered.filter(a => String(a.is_active || '').toLowerCase() === status);
  const code = $('filterAnimalsCode')?.value.toLowerCase();
  if (code) filtered = filtered.filter(a => (a.animal_code || '').toLowerCase().includes(code));
  const search = $('searchAnimals')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(a => 
      (a.animal_code || '').toLowerCase().includes(search) ||
      (a.animal_name || a.name || '').toLowerCase().includes(search) ||
      (a.animal_type || '').toLowerCase().includes(search) ||
      (a.is_active || '').toLowerCase().includes(search)
    );
  }
  return filtered.slice(0,40);
}
function renderAnimals(){
  const tbody = document.querySelector('#animalsTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredAnimals();
  if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="5" class="small">Ù„Ø§ Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }
  filtered.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(a.animal_code||a.code||'')}</td><td>${escapeHtml(a.animal_name||a.name||'')}</td><td>${escapeHtml(a.animal_type||'')}</td><td>${escapeHtml(a.is_active||'')}</td><td class="no-print"><button class="btn btn.ghost" onclick="openAnimal('${encodeURIComponent(a.animal_code||a.code||'')}')">ÙØªØ­</button></td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ø­ÙŠÙˆØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function getFilteredAdoptions() {
  let filtered = adoptions;
  const type = $('filterAdoptionsType')?.value;
  if (type) filtered = filtered.filter(ad => {
    const animalType = ad.animal_type || (ad.animal_code || '').includes('cat') ? 'cats' : 'dogs';
    return animalType === type;
  });
  const op = $('filterAdoptionsOperation')?.value;
  if (op) filtered = filtered.filter(ad => String(ad.Operation_type || ad.status || '').toLowerCase() === op);
  const search = $('searchAdoptions')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(ad => 
      (ad.animal_code || '').toLowerCase().includes(search) ||
      (ad.adopter_name || ad.adopterName || ad.adopter || '').toLowerCase().includes(search) ||
      (ad.adoption_date || ad.date || '').toLowerCase().includes(search) ||
      (ad.Operation_type || ad.status || '').toLowerCase().includes(search)
    );
  }
  return filtered;
}
function renderAdoptions(){
  const tbody = document.querySelector('#adoptionsTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredAdoptions();
  const adoptCount = adoptions.filter(ad => String(ad.Operation_type || ad.status || '').toLowerCase() === 'adopt').length;
  const reserveCount = adoptions.filter(ad => String(ad.Operation_type || ad.status || '').toLowerCase() === 'reserve').length;
  console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ¨Ù†ÙŠ:', { adoptCount, reserveCount });
  $('statsAdoptionsAdopt').textContent = adoptCount;
  $('statsAdoptionsReserve').textContent = reserveCount;
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="small">Ù„Ø§ Ø³Ø¬Ù„Ø§Øª ØªØ¨Ù†ÙŠ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return;
  }
  filtered.forEach(ad=>{
    const id = ad.adoption_id || ad.id || ad.AdoptionID || ad.adoptionId || '';
    const animal = ad.animal_code || ad.animalCode || '';
    const name = ad.adopter_name || ad.adopterName || ad.adopter || '';
    const date = ad.adoption_date || ad.date || '';
    const status = (ad.Operation_type || ad.status || ad.operation || '').toLowerCase();
    const isReserve = status === 'reserve';
    const tr = document.createElement('tr');
    let actions = `<button class="btn btn.ghost" onclick="openAdoption(${encodeURIComponent(id)})">ÙØªØ­</button>`;
    if (isReserve) {
      actions += `<button class="btn adopt" onclick="processAdoption('${encodeURIComponent(id)}','adopt')">ØªØ¨Ù†ÙŠ</button>`;
    }
    tr.innerHTML = `<td>${escapeHtml(id)}</td><td>${escapeHtml(animal)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(status)}</td>
      <td class="no-print">${actions}</td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ø³Ø¬Ù„ ØªØ¨Ù†ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function getFilteredMovements() {
  let filtered = movements;
  const animal = $('filterMovementsAnimal')?.value.toLowerCase();
  if (animal) filtered = filtered.filter(m => (m.animal_code || '').toLowerCase().includes(animal));
  const search = $('searchMovements')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(m => 
      (m.movement_date || m.CreatedAt || '').toLowerCase().includes(search) ||
      (m.animal_code || m.AnimalCode || '').toLowerCase().includes(search) ||
      (m.movement_type || '').toLowerCase().includes(search) ||
      (m.reason || '').toLowerCase().includes(search) ||
      (m.notes || '').toLowerCase().includes(search)
    );
  }
  return filtered.slice().sort((a,b)=> new Date(b.movement_date)-new Date(a.movement_date)).slice(0,40);
}
function renderMovements(){
  const tbody = document.querySelector('#movementsTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredMovements();
  if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="6" class="small">Ù„Ø§ Ø­Ø±ÙƒØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }
  filtered.forEach(m=>{
    const id = m.id || m.MovementID || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(m.movement_date||m.CreatedAt||'')}</td><td>${escapeHtml(m.animal_code||m.AnimalCode||'')}</td><td>${escapeHtml(m.movement_type||'')}</td><td>${escapeHtml(m.reason||'')}</td><td class="no-print">${escapeHtml(m.notes||'')}</td><td class="no-print"><button class="btn btn.ghost" onclick="openMovement(${id})">ÙØªØ­</button></td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ø­Ø±ÙƒØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function getFilteredRooms() {
  let filtered = rooms;
  const type = $('filterRoomsType')?.value;
  if (type) filtered = filtered.filter(r => {
    if (type === 'cats' && (r.cats || 0) > 0) return true;
    if (type === 'dogs' && (r.dogs || 0) > 0) return true;
    return false;
  });
  const animal = $('filterRoomsAnimal')?.value.toLowerCase();
  if (animal) {
    filtered = filtered.filter(r => (r.occupants || '').toLowerCase().includes(animal));
  }
  const search = $('searchRooms')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(r => 
      (r.room_name || r.name || '').toLowerCase().includes(search) ||
      String(r.capacity || '').includes(search) ||
      String(r.occupancy || '').includes(search) ||
      String((r.dogs||0) + '/' + (r.cats||0)).includes(search)
    );
  }
  return filtered;
}
function renderRooms(){
  const tbody = document.querySelector('#roomsTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredRooms();
  const catsRooms = rooms.filter(r => (r.cats || 0) > 0).length;
  const dogsRooms = rooms.filter(r => (r.dogs || 0) > 0).length;
  console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºØ±Ù:', { catsRooms, dogsRooms });
  $('statsRoomsCats').textContent = catsRooms;
  $('statsRoomsDogs').textContent = dogsRooms;
  if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="5" class="small">Ù„Ø§ ØºØ±Ù Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }
  filtered.forEach(r=>{
    const id = r.room_id || r.id || r.RoomID || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.room_name||r.name||'')}</td><td>${r.capacity||0}</td><td>${r.occupancy||0}</td><td>${(r.dogs||0) + '/' + (r.cats||0)}</td><td class="no-print"><button class="btn btn.ghost" onclick="openRoom(${id})">ÙØªØ­</button></td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'ØºØ±ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function getFilteredApplications() {
  let filtered = applications;
  const search = $('searchApplications')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(a => 
      (a.full_name || a.adopter_name || '').toLowerCase().includes(search) ||
      (a.phone || a.adopter_phone || '').toLowerCase().includes(search) ||
      (a.submission_date || a.created_at || '').toLowerCase().includes(search)
    );
  }
  return filtered;
}
function renderApplications(){
  const wrap = document.getElementById('applicationsList'); wrap.innerHTML = '';
  const filtered = getFilteredApplications();
  console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', filtered.length);
  if (!filtered.length) { wrap.innerHTML = '<div class="small">Ù„Ø§ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div>'; return; }
  const tbl = document.createElement('table'); tbl.className = 'table';
  tbl.innerHTML = '<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ù‡Ø§ØªÙ</th><th>ØªØ§Ø±ÙŠØ®</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>';
  const tb = document.createElement('tbody');
  filtered.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(a.full_name||a.adopter_name||'')}</td><td>${escapeHtml(a.phone||a.adopter_phone||'')}</td><td>${escapeHtml(a.submission_date||a.created_at||'')}</td><td class="no-print"><button class="btn btn.ghost" onclick="openApplication(${a.id})">Ø¹Ø±Ø¶</button> <button class="btn" onclick="confirmApproveApplication(${a.id})">Ø§Ø¹ØªÙ…Ø§Ø¯</button></td>`;
    tb.appendChild(tr);
  });
  tbl.appendChild(tb); wrap.appendChild(tbl);
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function getFilteredIncoming() {
  let filtered = incoming;
  const search = $('searchIncoming')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(i => 
      (i.animal_type || i.type || '').toLowerCase().includes(search) ||
      String(i.requests ?? i.count ?? i.num ?? 0).includes(search) ||
      String(i.quantity ?? i.total_quantity ?? i.qty ?? 0).includes(search)
    );
  }
  return filtered;
}
function renderIncoming(){
  const tbody = document.querySelector('#incomingTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredIncoming();
  if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="3" class="small">Ù„Ø§ Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }
  filtered.forEach(i=>{
    const requests = i.requests ?? i.count ?? i.num ?? 0;
    const qty = i.quantity ?? i.total_quantity ?? i.qty ?? 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(i.animal_type||i.type||'')}</td><td>${requests}</td><td>${qty}</td>`;
    tbody.appendChild(tr);
  });
  console.log('ØªÙ… Ø¹Ø±Ø¶', filtered.length, 'Ø·Ù„Ø¨ ÙˆØ§Ø±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±');
}
function renderVisitors(){
  if (!visitorsSummary) return;
  $('vis_total').textContent = visitorsSummary.total ?? '--';
  $('vis_today').textContent = visitorsSummary.today ?? '--';
  console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙˆØ§Ø±:', visitorsSummary);
}
/* ---------- alerts check ---------- */
function checkAlerts() {
  const lowStock = products.filter(p => (p.Quantity ?? 0) <= (p.MinQuantity ?? 0)).length;
  const today = new Date().toISOString().slice(0,10);
  const todayVisits = visits.filter(v => (v.visit_date||'').slice(0,10) === today).length;
  const reserveCount = adoptions.filter(ad => String(ad.Operation_type || ad.status || '').toLowerCase() === 'reserve').length;
  const appCount = applications.length;

  if (lowStock > LOW_STOCK_THRESHOLD) {
    showToast(`ØªÙ†Ø¨ÙŠÙ‡: ${lowStock} Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!`, 'warning');
  }
  if (reserveCount > RESERVE_THRESHOLD) {
    showToast(`ØªÙ†Ø¨ÙŠÙ‡: ${reserveCount} Ø­Ø¬ÙˆØ²Ø§Øª ØªØ¨Ù†ÙŠ Ù…Ø¹Ù„Ù‚Ø©!`, 'danger');
  }
  if (todayVisits > VISIT_THRESHOLD) {
    showToast(`ØªÙ†Ø¨ÙŠÙ‡: ${todayVisits} Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…!`, 'warning');
  }
  if (appCount > 5) {
    showToast(`ØªÙ†Ø¨ÙŠÙ‡: ${appCount} Ø·Ù„Ø¨Ø§Øª ØªØ¨Ù†ÙŠ Ù…Ø¹Ù„Ù‚Ø©.`, 'warning');
  }
}
/* ---------- actions (unchanged) ---------- */
function openProduct(id){ if (!id) return alert('Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±'); window.open(`/health_vet/public/add_Products.html?ProductID=${id}`, '_blank'); }
function openVisit(id){ if (!id) return alert('ID missing'); window.location.href = `/health_vet/public/add_visit.html?id=${id}`; }
function openAnimal(code){ window.open(`/health_vet/public/add_animals.html?ID=${code}`, '_blank'); }
function openAdoption(id){ window.open(`/health_vet/public/add_adopter.html?id=${decodeURIComponent(id)}`, '_blank'); }
function openApplication(id){
  fetch(`${API_BASE}add_adoption_applications.php?action=get_details&id=${id}`, { credentials:'same-origin' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.open(`/health_vet/public/add_applications.html?id=${id}`, '_blank');
      } else {
        alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
      }
    })
    .catch(() => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'));
}
function openRoom(id) {
  fetch(`${API_BASE}add_room.php?action=get&id=${id}`, { credentials:'same-origin' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.open(`/health_vet/public/add_room.html?id=${id}`, '_blank');
      } else {
        alert('ÙØ´Ù„ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØºØ±ÙØ©');
      }
    })
    .catch(() => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'));
}
function openMovement(id) {
  if (!id) return alert('ID missing');
  window.open(`/health_vet/public/animal_building.html?id=${id}`, '_blank');
}
async function confirmApproveApplication(appId){
  if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø·Ù„Ø¨ Ø§Ù„ØªØ¨Ù†ÙŠØŸ')) return;
  try {
    const fd = new FormData(); fd.set('action','approve'); fd.set('application_id', String(appId));
    const res = await fetch(API_BASE + 'process_adoption.php', { method:'POST', body: fd, credentials:'same-origin' });
    const j = await res.json();
    if (!j.success) return alert(j.message || 'ÙØ´Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯');
    alert('ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯');
    await refreshAll();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}
async function processAdoption(adoptionId, action){
  if (!confirm(`ØªÙ†ÙÙŠØ° ${action} Ù„Ù„ØªØ¨Ù†ÙŠ #${decodeURIComponent(adoptionId)}ØŸ`)) return;
  try {
    const fd = new FormData(); fd.set('action', action); fd.set('adoption_id', decodeURIComponent(adoptionId));
    const res = await fetch(API_BASE + 'process_adoption.php', { method:'POST', body: fd, credentials:'same-origin' });
    const j = await res.json();
    if (!j.success) return alert(j.message || 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
    alert(j.message || 'Ù†Ø¬Ø­Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
    await refreshAll();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}
/* ---------- cleanup ---------- */
async function runCleanupReservations(){
  if (!confirm('ØªØ´ØºÙŠÙ„ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¢Ù†ØŸ ÙŠÙÙ†ØµØ­ ØªØ´ØºÙŠÙ„Ù‡ ÙƒÙ€ cron ÙŠÙˆÙ…ÙŠ.')) return;
  try {
    const res = await fetch(API_BASE + 'cleanup_reservations.php', { method:'GET', credentials:'same-origin' });
    const j = await res.json();
    if (!j.success) return alert(j.message || 'ÙØ´Ù„');
    alert(`Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ†Ø¸ÙŠÙ â€” ${j.count || 0} Ø³Ø¬Ù„/Ø³Ø¬Ù„Ø§Øª Ø¹ÙˆÙ„Ø¬Øª`);
    await refreshAll();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}
/* ---------- scanner ---------- */
let videoStream = null, scanTimer = null;
function openScanModal(){
  const m = document.getElementById('scanModal'); m.classList.add('show'); m.setAttribute('aria-hidden','false');
  const video = document.getElementById('scanVideo');
  navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } }).then(stream=>{
    videoStream = stream; video.srcObject = stream; video.play();
    scanTimer = setInterval(()=> scanFrame(video), 300);
  }).catch(err=>{ alert('ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); console.error(err); closeScanModal(); });
}
function closeScanModal(){ const m=document.getElementById('scanModal'); m.classList.remove('show'); if (scanTimer) clearInterval(scanTimer); if (videoStream) { videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; } }
function scanFrame(video){
  if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
  const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);
  if (code && code.data) {
    $('globalSearch').value = code.data;
    closeScanModal();
    quickSearch();
  }
}
/* ---------- quick search ---------- */
async function quickSearch(){
  const q = $('globalSearch').value.trim();
  if (!q) return;
  console.log('Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ø¹Ù†:', q);
  // ... (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…ØŒ Ù…Ø¹ console.log)
  try {
    const r = await safeFetchJson(`get_products.php?lang=ar&per_page=10&q=${encodeURIComponent(q)}`);
    if (r && r.success && Array.isArray(r.data) && r.data.length) { openProduct(r.data[0].Product_ID); return; }
  } catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', e); }
  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙƒÙ…Ø§ Ù‡Ùˆ...
  alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù€ "${q}".`);
}
/* ---------- modal helpers ---------- */
function hideModal(){ const m=document.getElementById('modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
function showModal(html){ const m=document.getElementById('modal'); document.getElementById('modalBody').innerHTML = html; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g,c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>