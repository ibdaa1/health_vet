<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة إرسال التقارير — HealthVet</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;
    --accent:#556B2F;
    --muted:#6B7280;
    --text-primary:#2C1810;
    --border:#E5E5E5;
    --shadow:0 6px 20px rgba(85,107,47,0.08);
    --shadow-hover:0 8px 25px rgba(85,107,47,0.12);
    --radius:12px;
    font-family:"Tajawal",system-ui,Arial;
  }
  body{margin:0;background:var(--bg);color:var(--text-primary);line-height:1.6;font-weight:500;font-size:16px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;flex-wrap:wrap}
  .logo{width:52px;height:52px;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),#4A5D23);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.3rem;box-shadow:var(--shadow)}
  h1{margin:0;font-size:1.4rem;color:var(--accent);font-weight:700}
  .lang-toggle{padding:10px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);cursor:pointer;color:var(--muted);display:flex;align-items:center;gap:6px;font-size:1rem;transition:all 0.3s;font-weight:500}
  .lang-toggle:hover{box-shadow:var(--shadow-hover);color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:20px}
  .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:1px solid var(--border);transition:all 0.3s}
  .card:hover{box-shadow:var(--shadow-hover)}
  .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
  body[dir="rtl"] .tabs{flex-direction:row-reverse}
  .tab{padding:12px 16px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);cursor:pointer;color:var(--text-primary);font-size:1rem;transition:all 0.3s;font-weight:500;display:flex;align-items:center;gap:8px;width:100%;justify-content:center}
  .tab:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
  .tab.active{background:linear-gradient(135deg,var(--accent),#4A5D23);color:#fff;border-color:var(--accent);box-shadow:var(--shadow-hover)}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
  body[dir="rtl"] .controls{flex-direction:row-reverse}
  .search{flex:1;padding:12px 16px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);font-size:1rem;font-weight:500}
  .date{padding:12px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);font-size:1rem}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.95rem}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;font-weight:500}
  body[dir="rtl"] th,
  body[dir="rtl"] td {text-align:right}
  th{background:linear-gradient(135deg,#F8F9FA,#F0F4F0);color:var(--accent);text-align:left;font-weight:600;border-radius:var(--radius) 0 0 var(--radius);position:sticky;top:0}
  body[dir="rtl"] th{border-radius:0 var(--radius) var(--radius) 0}
  .small{font-size:0.9rem;color:var(--muted);font-weight:400}
  .btn{padding:12px;border-radius:var(--radius);border:0;background:var(--accent);color:#fff;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;width:48px;height:48px;transition:all 0.3s;box-shadow:var(--shadow)}
  .btn:hover{background:#4A5D23;transform:translateY(-2px);box-shadow:var(--shadow-hover)}
  .btn.ghost{background:var(--bg);border:1px solid var(--border);color:var(--muted)}
  .btn.ghost:hover{border-color:var(--accent);color:var(--accent);background:#F8F9FA}
  .rightPane{display:flex;flex-direction:column;gap:16px}
  .info{font-size:1rem;color:var(--text-primary);font-weight:500}
  .linkOut{word-break:break-all;color:var(--accent);background:#F8F9FA;padding:16px;border-radius:var(--radius);border:1px solid var(--border);margin-top:12px;font-family:monospace;font-size:0.9rem}
  .status{padding:12px;border-radius:var(--radius);background:#FFF8E1;border:1px solid #FFE082;color:var(--muted);font-weight:500}
  .row{display:flex;gap:12px;align-items:center}
  body[dir="rtl"] .row{flex-direction:row-reverse}
  .filters{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  label.small-inline{font-size:0.9rem;color:var(--muted);margin-left:8px;font-weight:500}
  body[dir="rtl"] label.small-inline{margin-left:0;margin-right:8px}
  .selected-row{background:#E8F5E8 !important;border-left:6px solid var(--accent) !important;}
  body[dir="rtl"] .selected-row{border-left:0 !important;border-right:6px solid var(--accent) !important;}
  ul{list-style:none;padding:0;margin:12px 0}
  ul li{padding:8px 0;position:relative;padding-left:20px;font-size:0.95rem}
  body[dir="rtl"] ul li{padding-left:0;padding-right:20px}
  ul li::before{content:"\f058";font-family:"Font Awesome 6 Free";font-weight:900;color:var(--accent);position:absolute;left:0}
  body[dir="rtl"] ul li::before{left:auto;right:0}
  @media(max-width:768px){
    .wrap{padding:12px}
    header{justify-content:center;text-align:center;gap:12px}
    .grid{grid-template-columns:1fr;gap:16px}
    .rightPane{order:-1}
    .controls{flex-direction:column;align-items:stretch;gap:8px}
    .search{width:100%}
    .tabs{justify-content:center;gap:4px}
    .tab{width:auto;min-width:120px;padding:10px 12px;font-size:0.9rem}
    table{font-size:0.85rem}
    th,td{padding:10px 8px}
    .btn{width:44px;height:44px;font-size:1rem}
  }
  @media(max-width:480px){
    body{font-size:15px}
    .tab{font-size:0.85rem;padding:8px 10px;min-width:100px}
    .btn{width:40px;height:40px;font-size:0.9rem}
    header h1{font-size:1.2rem}
    .logo{width:44px;height:44px;font-size:1.1rem}
  }
  /* Tooltips for buttons */
  .btn[title]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text-primary);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    white-space: nowrap;
    z-index: 10;
    margin-bottom: 5px;
    box-shadow: var(--shadow);
  }
  .btn[title]:hover::before {
    content: '';
    position: absolute;
    bottom: 90%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: var(--text-primary);
    z-index: 10;
  }
  body[dir="rtl"] .btn[title]:hover::after {left:auto;right:50%;transform:translateX(50%)}
  body[dir="rtl"] .btn[title]:hover::before {left:auto;right:50%;transform:translateX(50%)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:16px">
        <div class="logo">HV</div>
        <div>
          <h1 id="pageTitle">لوحة إرسال التقارير — HealthVet</h1>
          <div class="small" id="pageSubtitle">اختر سجل من الجداول ثم أنشئ الرابط أو أرسله — واتساب يعمل فورياً</div>
        </div>
      </div>
      <button class="lang-toggle" id="langToggle"><i class="fas fa-globe"></i> <span id="langLabel">English</span></button>
    </header>
    <div class="grid">
      <div class="card">
        <div class="tabs" role="tablist" aria-label="Tables">
          <button class="tab active" data-resource="adoptions" data-en="Adoptions Log (tbl_adoptions)" data-ar="سجل التبني (tbl_adoptions)"><i class="fas fa-paw" style="font-size:1.2rem"></i> <span class="tab-label">سجل التبني (tbl_adoptions)</span></button>
          <button class="tab" data-resource="adoption_applications" data-en="Adoption Applications" data-ar="طلبات التبني"><i class="fas fa-file-alt" style="font-size:1.2rem"></i> <span class="tab-label">طلبات التبني</span></button>
          <button class="tab" data-resource="animals" data-en="Animals (tbl_animals)" data-ar="الحيوانات (tbl_animals)"><i class="fas fa-heart" style="font-size:1.2rem"></i> <span class="tab-label">الحيوانات (tbl_animals)</span></button>
          <button class="tab" data-resource="visitor_interactions" data-en="Visitor Interactions" data-ar="تفاعل الزوار"><i class="fas fa-users" style="font-size:1.2rem"></i> <span class="tab-label">تفاعل الزوار</span></button>
        </div>
        <div class="controls">
          <select id="filterType" class="search">
            <option value="">كل الأنواع</option>
            <option value="Cats">قطط</option>
            <option value="Dogs">كلاب</option>
          </select>
          <select id="filterOperation" class="search">
            <option value="">كل الحالات</option>
            <option value="reserved">حجز</option>
            <option value="adopted">تبني</option>
          </select>
          <input id="qSearch" class="search" placeholder="بحث برقم/اسم/هاتف/رمز..." data-ar-placeholder="بحث برقم/اسم/هاتف/رمز..." data-en-placeholder="Search by ID/Name/Phone/Code..." />
          <div class="row">
            <label class="small-inline" id="fromLabel">من</label>
            <input id="dateFrom" type="date" class="date" />
          </div>
          <div class="row">
            <label class="small-inline" id="toLabel">إلى</label>
            <input id="dateTo" type="date" class="date" />
          </div>
          <button id="btnLoad" class="btn" title="تحميل"><i class="fas fa-download"></i></button>
        </div>
        <div class="small" id="tableHint">انقر على صف لتحديده ثم استخدم لوحة اليمين لإرسال التقرير عبر واتساب أو بريد لاحقاً.</div>
        <div style="margin-top:12px;overflow-x:auto" id="tableWrap">
          <table id="mainTable" aria-live="polite">
            <thead><tr id="tableHead"><th>--</th></tr></thead>
            <tbody id="tableBody"><tr><td class="small" id="emptyHint">اضغط "تحميل" لعرض السجلات</td></tr></tbody>
          </table>
        </div>
      </div>
      <aside class="rightPane">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <div>
              <strong id="sendDetailsTitle">تفاصيل الإرسال</strong>
              <div class="small" id="sendDetailsSub">سجل محدد • أنشئ رابطاً و أرسله</div>
            </div>
            <div id="selectedCount" class="small">محدد: 0</div>
          </div>
          <div style="margin-bottom:16px">
            <div id="selPreview" class="info">لم يتم اختيار أي سجل</div>
          </div>
          <div style="margin-bottom:16px">
            <label class="small" id="reportTypeLabel">نوع التقرير</label>
            <select id="reportType" class="search">
              <option value="reserved">تقرير الحجز</option>
              <option value="adopter">تقرير التبني</option>
              <option value="owner_animals">تقرير حيوانات المالك</option>
              <option value="applications">تفاصيل طلب تبني</option>
              <option value="visitor_interaction">تقرير تفاعل زائر</option>
            </select>
          </div>
          <div style="margin-bottom:16px">
            <label class="small" id="recipientLabel">البريد أو رقم الجوال (واتساب)</label>
            <input id="recipient" class="search" placeholder="البريد أو 9715..." data-ar-placeholder="البريد أو 9715..." data-en-placeholder="Email or 9715..." />
          </div>
          <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
            <button id="btnGenerate" class="btn" title="إنشاء رابط"><i class="fas fa-link"></i></button>
            <button id="btnSendEmail" class="btn btn.ghost" title="إرسال بريد"><i class="fas fa-envelope"></i></button>
            <button id="btnSendWa" class="btn btn.ghost" title="إرسال واتساب"><i class="fab fa-whatsapp"></i></button>
          </div>
          <div>
            <div id="genStatus" class="small"></div>
            <div id="generatedLink" style="margin-top:12px"></div>
          </div>
        </div>
        <div class="card">
          <div class="small" style="font-weight:600;margin-bottom:12px" id="instructionsTitle">تعليمات</div>
          <ul>
            <li id="inst1">اضغط على اسم الجدول ثم "تحميل" لجلب السجلات.</li>
            <li id="inst2">استخدم فلتر التاريخ بين تاريخين لتضييق النتائج بناءً على حقل التاريخ الملائم لكل جدول.</li>
            <li id="inst3">انقر على صف لتحديده ثم "إنشاء رابط" ثم أرسله واتساب أو بريد.</li>
            <li id="inst4">زر "إرسال واتساب" يفتح محادثة مع الرسالة الجاهزة (الرابط في سطر منفصل).</li>
            <li id="inst5">زر "إرسال بريد" يستدعي API الخادم؛ سيتم تهيئة تفاصيل SMTP لاحقاً حسب استضافتكم.</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>
    <script src="session_check.js"></script>
<script>
const API_BASE = '/health_vet/api/';
const GET_DATA = API_BASE + 'get_data.php';
const tableHead = document.getElementById('tableHead');
const tableBody = document.getElementById('tableBody');
const tabs = document.querySelectorAll('.tab');
let activeResource = 'adoptions';
let rowsCache = [];
let selectedRow = null;
let lastGenerated = { link: null, token: null, recordId: null, reportType: null };
let currentLang = 'ar';
let TRANSLATIONS = {};
const FALLBACK_TRANSLATIONS = {
  en: {
    pageTitle: 'Report Control Panel — HealthVet',
    pageSubtitle: 'Select a record from the tables, then generate the link or send it — WhatsApp works instantly',
    tableHint: 'Click on a row to select it, then use the right panel to send the report via WhatsApp or email later.',
    emptyHint: 'Click "Load" to display records',
    sendDetailsTitle: 'Send Details',
    sendDetailsSub: 'Selected Record • Generate Link and Send',
    noSelection: 'No record selected',
    reportTypeLabel: 'Report Type',
    recipientLabel: 'Email or Mobile Number (WhatsApp)',
    fromLabel: 'From',
    toLabel: 'To',
    instructionsTitle: 'Instructions',
    inst1: 'Click on the table name then "Load" to fetch records.',
    inst2: 'Use the date filter between two dates to narrow results based on the appropriate date field for each table.',
    inst3: 'Click on a row to select it then "Generate Link" and send via WhatsApp or email.',
    inst4: 'The "Send WhatsApp" button opens a chat with the ready message (link in a separate line).',
    inst5: 'The "Send Email" button calls the server API; SMTP details will be configured later based on your hosting.',
    langLabel: 'العربية',
    loadingMsg: 'Loading...',
    noRecords: 'No records found',
    selectedCount: 'Selected: {0}',
    alertSelectFirst: 'Select a record first',
    alertNoId: 'Cannot identify ID for selected record',
    alertEnterRecipient: 'Enter email or phone for WhatsApp',
    alertEmailSent: 'Email sent successfully',
    alertSendFailed: 'Send failed (Email setup pending): ',
    alertSendError: 'Send error',
    genStatusGenerating: 'Generating link...',
    genStatusGenerated: 'Generated.',
    genStatusFailed: 'Failed to generate link: ',
    genStatusError: 'Error',
    genStatusConnection: 'Connection error'
  },
  ar: {
    pageTitle: 'لوحة إرسال التقارير — HealthVet',
    pageSubtitle: 'اختر سجل من الجداول ثم أنشئ الرابط أو أرسله — واتساب يعمل فورياً',
    tableHint: 'انقر على صف لتحديده ثم استخدم لوحة اليمين لإرسال التقرير عبر واتساب أو بريد لاحقاً.',
    emptyHint: 'اضغط "تحميل" لعرض السجلات',
    sendDetailsTitle: 'تفاصيل الإرسال',
    sendDetailsSub: 'سجل محدد • أنشئ رابطاً و أرسله',
    noSelection: 'لم يتم اختيار أي سجل',
    reportTypeLabel: 'نوع التقرير',
    recipientLabel: 'البريد أو رقم الجوال (واتساب)',
    fromLabel: 'من',
    toLabel: 'إلى',
    instructionsTitle: 'تعليمات',
    inst1: 'اضغط على اسم الجدول ثم "تحميل" لجلب السجلات.',
    inst2: 'استخدم فلتر التاريخ بين تاريخين لتضييق النتائج بناءً على حقل التاريخ الملائم لكل جدول.',
    inst3: 'انقر على صف لتحديده ثم "إنشاء رابط" ثم أرسله واتساب أو بريد.',
    inst4: 'زر "إرسال واتساب" يفتح محادثة مع الرسالة الجاهزة (الرابط في سطر منفصل).',
    inst5: 'زر "إرسال بريد" يستدعي API الخادم؛ سيتم تهيئة تفاصيل SMTP لاحقاً حسب استضافتكم.',
    langLabel: 'English',
    loadingMsg: 'جاري التحميل...',
    noRecords: 'لا توجد سجلات',
    selectedCount: 'محدد: {0}',
    alertSelectFirst: 'اختر سجلًا أولاً',
    alertNoId: 'لا يمكن تحديد معرف للسجل المختار',
    alertEnterRecipient: 'أدخل البريد أو رقم الهاتف للواتساب',
    alertEmailSent: 'تم إرسال البريد',
    alertSendFailed: 'فشل الإرسال (سيتم تهيئة البريد لاحقاً): ',
    alertSendError: 'خطأ في الإرسال',
    genStatusGenerating: 'جارٍ إنشاء الرابط...',
    genStatusGenerated: 'تم الإنشاء.',
    genStatusFailed: 'فشل إنشاء الرابط: ',
    genStatusError: 'خطأ',
    genStatusConnection: 'خطأ بالاتصال'
  }
};
const FILTER_TYPE_OPTS = [
  {value: '', en: 'All Types', ar: 'كل الأنواع'},
  {value: 'Cats', en: 'Cats', ar: 'قطط'},
  {value: 'Dogs', en: 'Dogs', ar: 'كلاب'}
];
const FILTER_OP_OPTS = [
  {value: '', en: 'All Statuses', ar: 'كل الحالات'},
  {value: 'reserved', en: 'Reserved', ar: 'حجز'},
  {value: 'adopted', en: 'Adopted', ar: 'تبني'}
];
const REPORT_TYPE_OPTS = [
  {value: 'reserved', en: 'Reservation Report', ar: 'تقرير الحجز'},
  {value: 'adopter', en: 'Adoption Report', ar: 'تقرير التبني'},
  {value: 'owner_animals', en: 'Owner Animals Report', ar: 'تقرير حيوانات المالك'},
  {value: 'applications', en: 'Application Details', ar: 'تفاصيل طلب تبني'},
  {value: 'visitor_interaction', en: 'Visitor Interaction Report', ar: 'تقرير تفاعل زائر'}
];
const RESOURCE_TO_REPORT_TYPE = {
  'adoptions': 'adopter',
  'adoption_applications': 'applications',
  'animals': 'owner_animals',
  'visitor_interactions': 'visitor_interaction'
};
const HEADERS = {
  en: {
    adoptions: ['#', 'Animal', 'Adopter', 'Date', 'Status'],
    adoption_applications: ['#', 'Name', 'Phone', 'Email', 'Date'],
    animals: ['ID', 'Name', 'Type', 'Status'],
    visitor_interactions: ['#', 'Name', 'Date', 'Visit Type', 'Phone']
  },
  ar: {
    adoptions: ['#', 'حيوان', 'متبني', 'تاريخ', 'حالة'],
    adoption_applications: ['#', 'الاسم', 'هاتف', 'بريد', 'تاريخ'],
    animals: ['رمز', 'الاسم', 'نوع', 'الحالة'],
    visitor_interactions: ['#', 'الاسم', 'التاريخ', 'نوع الزيارة', 'الهاتف']
  }
};
const TOOLTIPS = {
  btnLoad: {en: 'Load', ar: 'تحميل'},
  btnGenerate: {en: 'Generate Link', ar: 'إنشاء رابط'},
  btnSendEmail: {en: 'Send Email', ar: 'إرسال بريد'},
  btnSendWa: {en: 'Send WhatsApp', ar: 'إرسال واتساب'}
};
const REPORT_LABELS = {
  'reserved': 'Reservation Report',
  'adopter': 'Adoption Report',
  'owner_animals': 'Owner Animals Report',
  'applications': 'Application Details',
  'visitor_interaction': 'Visitor Interaction Report'
};
function getRecordId(row, resource) {
  switch(resource) {
    case 'adoptions': return row.adoption_id || row.id || '';
    case 'adoption_applications': return row.id || '';
    case 'animals': return row.animal_code || row.code || row.id || '';
    case 'visitor_interactions': return row.id || '';
    default: return row.id || '';
  }
}
async function loadTranslations(lang) {
  if (TRANSLATIONS[lang]) return TRANSLATIONS[lang];
  try {
    const res = await fetch(`/health_vet/languages/${lang}_send_reports.json`);
    if (res.ok) {
      TRANSLATIONS[lang] = await res.json();
      return TRANSLATIONS[lang];
    }
  } catch (e) {
    console.warn(`Failed to load ${lang} translations, using fallback`);
  }
  TRANSLATIONS[lang] = FALLBACK_TRANSLATIONS[lang];
  return TRANSLATIONS[lang];
}
function updateSelectOptions(id, opts, lang) {
  const select = document.getElementById(id);
  const currentValue = select.value;
  select.innerHTML = opts.map(opt => `<option value="${escapeHtml(opt.value)}">${escapeHtml(lang === 'ar' ? opt.ar : opt.en)}</option>`).join('');
  if (select.querySelector(`option[value="${currentValue}"]`)) {
    select.value = currentValue;
  } else {
    select.value = '';
  }
}
async function setLanguage(lang) {
  const trans = await loadTranslations(lang);
  currentLang = lang;
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  // Update texts
  document.querySelectorAll('[id]').forEach(el => {
    if (trans[el.id]) el.textContent = trans[el.id];
  });
  // Update tab labels
  document.querySelectorAll('.tab-label').forEach((label, i) => {
    const tab = tabs[i];
    const text = lang === 'ar' ? tab.dataset.ar : tab.dataset.en;
    label.textContent = text;
  });
  // Update selects
  updateSelectOptions('filterType', FILTER_TYPE_OPTS, lang);
  updateSelectOptions('filterOperation', FILTER_OP_OPTS, lang);
  updateSelectOptions('reportType', REPORT_TYPE_OPTS, lang);
  // Update placeholders
  const qSearch = document.getElementById('qSearch');
  qSearch.placeholder = lang === 'ar' ? qSearch.dataset.arPlaceholder : qSearch.dataset.enPlaceholder || 'Search by ID/Name/Phone/Code...';
  const recipient = document.getElementById('recipient');
  recipient.placeholder = lang === 'ar' ? recipient.dataset.arPlaceholder : recipient.dataset.enPlaceholder || 'Email or 9715...';
  // Update tooltips
  ['btnLoad', 'btnGenerate', 'btnSendEmail', 'btnSendWa'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn && TOOLTIPS[id]) {
      const tooltipText = TOOLTIPS[id][lang];
      btn.title = tooltipText;
      btn.dataset.tooltip = tooltipText;
    }
  });
  document.getElementById('selPreview').textContent = trans.noSelection;
  document.getElementById('langLabel').textContent = trans.langLabel;
  updateSelectionUI();
  if (rowsCache.length > 0) {
    renderTableForResource();
  }
}
function setActiveTab(res){
  activeResource = res;
  tabs.forEach(t => t.classList.toggle('active', t.dataset.resource === res));
  // Set report type automatically based on resource
  const reportTypeSelect = document.getElementById('reportType');
  const autoReportType = RESOURCE_TO_REPORT_TYPE[res];
  if (autoReportType) {
    reportTypeSelect.value = autoReportType;
  }
  clearTable();
}
tabs.forEach(t => t.addEventListener('click', ()=> setActiveTab(t.dataset.resource)));
document.getElementById('btnLoad').addEventListener('click', loadActiveTable);
document.getElementById('btnGenerate').addEventListener('click', generateLinkForSelected);
document.getElementById('btnSendEmail').addEventListener('click', sendEmailForSelected);
document.getElementById('btnSendWa').addEventListener('click', sendWaForSelected);
document.getElementById('qSearch').addEventListener('keydown', e=> { if(e.key==='Enter') loadActiveTable(); });
document.getElementById('langToggle').addEventListener('click', async () => {
  const newLang = currentLang === 'en' ? 'ar' : 'en';
  await setLanguage(newLang);
});
function clearTable(){
  const headers = HEADERS[currentLang][activeResource] || ['--'];
  const colspan = headers.length;
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  tableHead.innerHTML = `<tr><th colspan="${colspan}">${escapeHtml(t.emptyHint)}</th></tr>`;
  tableBody.innerHTML = `<tr><td colspan="${colspan}" class="small">${escapeHtml(t.emptyHint)}</td></tr>`;
  rowsCache = []; selectedRow = null; updateSelectionUI();
}
function updateSelectionUI(){
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  const count = selectedRow ? 1 : 0;
  document.getElementById('selectedCount').textContent = t.selectedCount.replace('{0}', count);
  const preview = document.getElementById('selPreview');
  if (!selectedRow) {
    preview.textContent = t.noSelection;
    return;
  }
  let previewHtml = '';
  switch(activeResource) {
    case 'animals':
      previewHtml = `<strong>${escapeHtml(selectedRow.animal_code||selectedRow.code||'')}</strong><div class="small">${escapeHtml(selectedRow.animal_name||selectedRow.name||'')}</div>`;
      document.getElementById('recipient').value = selectedRow.owner_email || selectedRow.owner_phone || '';
      break;
    case 'adoptions':
      previewHtml = `<strong>#${escapeHtml(selectedRow.adoption_id||selectedRow.id||'')}</strong><div class="small">${escapeHtml(selectedRow.animal_code||'')} · ${escapeHtml(selectedRow.adopter_name||'')}</div>`;
      document.getElementById('recipient').value = selectedRow.adopter_email || selectedRow.adopter_phone || '';
      break;
    case 'adoption_applications':
      previewHtml = `<strong>#${escapeHtml(selectedRow.id||'')}</strong><div class="small">${escapeHtml(selectedRow.full_name||'')} · ${escapeHtml(selectedRow.phone||'')}</div>`;
      document.getElementById('recipient').value = selectedRow.email || selectedRow.phone || '';
      break;
    case 'visitor_interactions':
      previewHtml = `<strong>#${escapeHtml(selectedRow.id||'')}</strong><div class="small">${escapeHtml(selectedRow.visitor_full_name||'')} · ${escapeHtml(selectedRow.visitor_contact_number||'')}</div>`;
      document.getElementById('recipient').value = selectedRow.visitor_contact_number || '';
      break;
  }
  preview.innerHTML = previewHtml;
  document.getElementById('generatedLink').innerHTML = '';
  document.getElementById('genStatus').textContent = '';
}
async function safeFetchJson(url){
  try {
    const res = await fetch(url, { credentials:'same-origin' });
    const txt = await res.text();
    try { return { ok:true, json: JSON.parse(txt) }; } catch(e) { return { ok:true, text: txt }; }
  } catch(e){ return { ok:false, error: e.message }; }
}
async function tryPaths(paths){
  for (const p of paths){
    const url = p.startsWith('/') ? p : (API_BASE + p);
    const r = await safeFetchJson(url);
    if (!r.ok) continue;
    if (r.json && Array.isArray(r.json)) return r.json;
    if (r.json && r.json.success && Array.isArray(r.json.data)) return r.json.data;
    if (r.json && Array.isArray(r.json.data)) return r.json.data;
    if (r.json && Array.isArray(r.json.rows)) return r.json.rows;
    if (r.json && Array.isArray(r.json.visits)) return r.json.visits;
    if (r.json && typeof r.json === 'object' && Object.keys(r.json).length) {
      if (Array.isArray(r.json.data)) return r.json.data;
      if (Array.isArray(r.json.adoptions)) return r.json.adoptions;
    }
    if (r.text) {
      const txt = r.text.trim();
      if (txt.startsWith('[') || txt.startsWith('{')) {
        try { const j = JSON.parse(txt); if (Array.isArray(j)) return j; if (j.data && Array.isArray(j.data)) return j.data; } catch(e){}
      }
    }
  }
  return [];
}
function parseDateValue(s){
  if (!s) return null;
  const d = new Date(s);
  if (isNaN(d.getTime())) return null;
  return d;
}
function rowDateForResource(row){
  try {
    if (activeResource === 'adoptions') return parseDateValue(row.adoption_date || row.date || row.created_at || row.createdAt);
    if (activeResource === 'adoption_applications') return parseDateValue(row.submission_date || row.created_at || row.createdAt);
    if (activeResource === 'visitor_interactions') return parseDateValue(row.visit_date || row.VisitDate || row.created_at);
    if (activeResource === 'animals') return parseDateValue(row.registration_date || row.created_at || row.createdAt);
  } catch(e){}
  return null;
}
function inDateRange(row, fromStr, toStr){
  if (!fromStr && !toStr) return true;
  const from = fromStr ? new Date(fromStr) : null;
  const to = toStr ? new Date(toStr) : null;
  const rdate = rowDateForResource(row);
  if (!rdate) {
    return !fromStr && !toStr;
  }
  if (from && rdate < new Date(from.getFullYear(), from.getMonth(), from.getDate(), 0,0,0)) return false;
  if (to) {
    const endOfTo = new Date(to.getFullYear(), to.getMonth(), to.getDate(), 23,59,59,999);
    if (rdate > endOfTo) return false;
  }
  return true;
}
async function loadActiveTable(){
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  document.getElementById('btnLoad').disabled = true;
  const headers = HEADERS[currentLang][activeResource] || [];
  const colspan = headers.length || 1;
  tableBody.innerHTML = `<tr><td colspan="${colspan}" class="small">${t.loadingMsg}</td></tr>`;
  const q = document.getElementById('qSearch').value.trim();
  const typeFilter = document.getElementById('filterType').value;
  const opFilter = document.getElementById('filterOperation').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  let data = [];
  if (activeResource === 'adoptions') {
    data = await tryPaths([`${GET_DATA}?resource=adoptions&page=1&per_page=200&q=${encodeURIComponent(q)}`,'get_adoptions.php','get_adoptions_list.php','get_table.php?name=tbl_adoptions']);
  } else if (activeResource === 'adoption_applications') {
    data = await tryPaths([`${GET_DATA}?resource=adoption_applications&page=1&per_page=200&q=${encodeURIComponent(q)}`,'get_adoption_applications.php','get_adoption_applications_pending.php','get_table.php?name=adoption_applications']);
  } else if (activeResource === 'animals') {
    data = await tryPaths([`${GET_DATA}?resource=animals&page=1&per_page=300&q=${encodeURIComponent(q)}`,'get_animals.php?per_page=500','get_table.php?name=tbl_animals']);
  } else if (activeResource === 'visitor_interactions') {
    data = await tryPaths([`${GET_DATA}?resource=visitor_interactions&page=1&per_page=200&q=${encodeURIComponent(q)}`,'get_visitor_interactions.php','get_table.php?name=visitor_interactions']);
  }
  if (typeFilter && data.length) {
    data = data.filter(r => ((r.animal_type||r.AnimalType||'')+'').toString().toLowerCase().includes(typeFilter.toLowerCase()));
  }
  if (opFilter && data.length) {
    data = data.filter(r => ((r.Operation_type||r.operation||r.status||'')+'').toString().toLowerCase().includes(opFilter.toLowerCase()));
  }
  if (dateFrom || dateTo) {
    data = data.filter(r => inDateRange(r, dateFrom, dateTo));
  }
  rowsCache = data || [];
  renderTableForResource();
  document.getElementById('btnLoad').disabled = false;
}
function renderTableForResource(){
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  const headers = HEADERS[currentLang][activeResource] || [];
  const colspan = headers.length || 1;
  tableHead.innerHTML = '';
  tableBody.innerHTML = '';
  if (!rowsCache || !rowsCache.length) {
    const msg = t.noRecords;
    tableHead.innerHTML = `<tr><th colspan="${colspan}">${escapeHtml(msg)}</th></tr>`;
    tableBody.innerHTML = `<tr><td colspan="${colspan}" class="small">${escapeHtml(msg)}</td></tr>`;
    return;
  }
  tableHead.innerHTML = `<tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr>`;
  if (activeResource === 'animals') {
    for (const r of rowsCache) {
      const recordId = getRecordId(r, activeResource);
      const tr = document.createElement('tr');
      tr.dataset.recordId = recordId;
      tr.innerHTML = `<td>${escapeHtml(r.animal_code||r.code||'')}</td><td>${escapeHtml(r.animal_name||r.name||'')}</td><td>${escapeHtml(r.animal_type||'')}</td><td>${escapeHtml(r.is_active||r.status||'')}</td>`;
      tr.onclick = ()=> selectRow(r);
      tableBody.appendChild(tr);
    }
  } else if (activeResource === 'adoptions') {
    for (const r of rowsCache) {
      const recordId = getRecordId(r, activeResource);
      const tr = document.createElement('tr');
      tr.dataset.recordId = recordId;
      const id = recordId;
      tr.innerHTML = `<td>${escapeHtml(id)}</td><td>${escapeHtml(r.animal_code||'')}</td><td>${escapeHtml(r.adopter_name||'')}</td><td>${escapeHtml(r.adoption_date||r.date||'')}</td><td>${escapeHtml(r.Operation_type||r.status||'')}</td>`;
      tr.onclick = ()=> selectRow(r);
      tableBody.appendChild(tr);
    }
  } else if (activeResource === 'adoption_applications') {
    for (const r of rowsCache) {
      const recordId = getRecordId(r, activeResource);
      const tr = document.createElement('tr');
      tr.dataset.recordId = recordId;
      tr.innerHTML = `<td>${escapeHtml(recordId)}</td><td>${escapeHtml(r.full_name||'')}</td><td>${escapeHtml(r.phone||'')}</td><td>${escapeHtml(r.email||'')}</td><td>${escapeHtml(r.submission_date||r.created_at||'')}</td>`;
      tr.onclick = ()=> selectRow(r);
      tableBody.appendChild(tr);
    }
  } else if (activeResource === 'visitor_interactions') {
    for (const r of rowsCache) {
      const recordId = getRecordId(r, activeResource);
      const tr = document.createElement('tr');
      tr.dataset.recordId = recordId;
      tr.innerHTML = `<td>${escapeHtml(recordId)}</td><td>${escapeHtml(r.visitor_full_name||'')}</td><td>${escapeHtml(r.visit_date||'')}</td><td>${escapeHtml(r.visit_type||'')}</td><td>${escapeHtml(r.visitor_contact_number||'')}</td>`;
      tr.onclick = ()=> selectRow(r);
      tableBody.appendChild(tr);
    }
  }
}
function selectRow(row){
  selectedRow = row;
  updateSelectionUI();
  tableBody.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected-row'));
  const recordId = getRecordId(row, activeResource);
  const targetTr = tableBody.querySelector(`tr[data-record-id="${recordId}"]`);
  if (targetTr) targetTr.classList.add('selected-row');
}
function buildReportMessage(reportTypeLabel, recordId, link) {
  const header = "Sharjah City Municipality\nSharjah Cats & Dogs Shelter";
  const reportLine = `Report: ${reportTypeLabel} #${recordId}`;
  const body = `${header}\n${reportLine}\n\n${link}`;
  const subject = `${reportLine} — Sharjah Cats & Dogs Shelter`;
  return { subject, body };
}
async function generateLinkForSelected(){
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  if (!selectedRow) return alert(t.alertSelectFirst);
  const reportType = document.getElementById('reportType').value;
  let recordId = getRecordId(selectedRow, activeResource);
  if (!recordId && recordId !== 0) return alert(t.alertNoId);
  document.getElementById('genStatus').textContent = t.genStatusGenerating;
  const fd = new FormData();
  fd.append('report_type', reportType);
  fd.append('record_id', String(recordId));
  fd.append('recipient', document.getElementById('recipient').value || '');
  fd.append('expires_minutes', '2880');
  try {
    const res = await fetch(API_BASE + 'generate_report_token.php', { method:'POST', body: fd, credentials:'same-origin' });
    const j = await res.json().catch(()=>null);
    if (!j || !j.success) {
      document.getElementById('genStatus').textContent = t.genStatusFailed + (j && j.message ? j.message : t.genStatusError);
      return;
    }
    let link = j.link || '';
    if (link && !link.startsWith('http')) {
      const proto = (location.protocol || 'https:') + '//';
      link = proto + location.host + (link.startsWith('/') ? '' : '/') + link;
    }
    document.getElementById('genStatus').textContent = t.genStatusGenerated;
    const linkEl = document.getElementById('generatedLink');
    linkEl.innerHTML = `<div class="linkOut"><a href="${escapeHtml(link)}" target="_blank">${escapeHtml(link)}</a></div>`;
    lastGenerated = { link, token: j.token, recordId, reportType };
    window._lastReportLink = link;
    window._lastToken = j.token;
    window._lastRecordId = recordId;
    window._lastReportType = reportType;
  } catch(e){
    document.getElementById('genStatus').textContent = t.genStatusConnection;
    console.error(e);
  }
}
async function sendEmailForSelected(){
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  if (!selectedRow) return alert(t.alertSelectFirst);
  if (!lastGenerated.link) {
    await generateLinkForSelected();
    if (!lastGenerated.link) return;
  }
  const to = document.getElementById('recipient').value.trim();
  if (!to) return alert(t.alertEnterRecipient);
  const reportLabel = REPORT_LABELS[lastGenerated.reportType] || lastGenerated.reportType;
  const { subject, body } = buildReportMessage(reportLabel, lastGenerated.recordId, lastGenerated.link);
  const payload = new URLSearchParams();
  payload.set('to', to);
  payload.set('subject', subject);
  payload.set('body', body);
  try {
    const res = await fetch(API_BASE + 'send_report_mail.php', { method:'POST', body: payload, credentials:'same-origin' });
    const j = await res.json().catch(()=>null);
    if (j && j.success) {
      alert(t.alertEmailSent);
    } else {
      alert(t.alertSendFailed + (j && j.message ? j.message : JSON.stringify(j)));
    }
  } catch(e){ console.error(e); alert(t.alertSendError); }
}
function sendWaForSelected(){
  const t = TRANSLATIONS[currentLang] || FALLBACK_TRANSLATIONS[currentLang];
  if (!selectedRow) return alert(t.alertSelectFirst);
  if (!lastGenerated.link) {
    generateLinkForSelected();
    return;
  }
  const recipientRaw = document.getElementById('recipient').value.trim();
  const recipientDigits = recipientRaw.replace(/\D/g,'');
  const reportLabel = REPORT_LABELS[lastGenerated.reportType] || lastGenerated.reportType;
  const { body } = buildReportMessage(reportLabel, lastGenerated.recordId, lastGenerated.link);
  const msg = encodeURIComponent(body);
  if (recipientDigits) {
    window.open(`https://wa.me/${recipientDigits}?text=${msg}`, '_blank');
  } else {
    window.open(`https://wa.me/?text=${msg}`, '_blank');
  }
}
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
(async () => {
  await setLanguage('ar');
  setActiveTab('adoptions');
})();
</script>
</body>
</html>